* Relatorio do SPED
********************
FUNCTION sped
**************
LOCAL MPRG:='SPED',mtitulo:='EMISSAO DO ARQUIVO DO SPED PIS-CONFINS',;
      lba,cba,opcao,mdata1,mdata2,;
      mcont_10:=0,mcont_11:=0,mcont_50:=0,mcont_51:=0,mcont_53:=0,mcont_54:=0,;
      mcont_90:=0,mcont_ger:=0,mcont_75:=0,mcont_60 :=0,;
      mponto,mdoc,ment_sai,mitem := 0,mop_nota:='G',m_produto:={},m_prodaux:={},m_cst:={},d_cst:={},;
      mqtd_c:=0,mqtd_200:=0,mqtd_990:=0,mqtd_9900:=0,mqtd_150:=0,mqtd_c100:=0,mqtd_c170:=0,mqtd_c190:=0,mapuracao := 0,mqtd_c370 := 0,mqtd_c390 := 0,;
      mqtd_400 := 0,mqtd_c350 := 0,mqtd_c400 := 0,mqtd_c405 := 0,mqtd_c420 := 0,mqtd_c470 := 0,mqtd_c490 := 0,mcons_emi := {},mcod_cid_emit,mcons_cont := {},;
      v_cst:={},mcli_mov := {},cons_cli := {}

PRIVATE mtipo_imp,mimp_tipo:=0,marq:=SPACE(35),mnome_arq:=''

*** VARIAVEIS DE IMPRESSAO ***
mtipo_imp := m_indiv[1,18]
******************************
IF ! ver_nivel(mprg,mtitulo,'15',nivel_acess,,'AMBIE')
        RETURN NIL
ENDIF

mtraco := REPLI('=',132)
lba := 4
cba := 70
//marq := 'C:\'+CURDIR()+'\SPED.TXT'+SPACE(30)
SET CENTURY ON
marq := 'C:\'+CURDIR()+'\'+STRTRAN(DTOC(DATE()),'/','')+STRTRAN(TIME(),':','')+'.TXT'+SPACE(30)
SET CENTURY OFF

op_tela(0,0,lba,cba,mtitulo)
SET CENTURY ON
WHILE .T.
        mcont_10:=0;mcont_11:=0;mcont_50:=0;mcont_51:=0;mcont_53:=0;mcont_54:=0
        mcont_90:=0;mcont_ger:=0;mcont_75:=0
********* VARIAVEIS DE IMPRESSAO *******************
        mtipo_imp := m_indiv[1,18]
****************************************************
        mdata1 := mdata_sis - 30
        mdata2 := mdata_sis
        m_produto := {}
        m_prodaux := {}
        mqtd_c := mqtd_200 := mqtd_c100 := mqtd_c170 := mapuracao := mqtd_c370 := mqtd_c390 := mqtd_c405 := 0
        mqtd_c420 := mqtd_c470 := mqtd_c490 := 0
        mensagem('Preencha os Campos - <ESC>p/Abandonar')
        DEVPOS(1,1);DEVOUT('Data Inicial...:')
        DEVPOS(2,1);DEVOUT('Data Final.....:')
        DEVPOS(3,1);DEVOUT('Caminho Arquivo:')
        setcor(1)

        @ 1,19 GET mdata1 PICT '99/99/99' VALID IF(EMPTY(mdata1),.F.,.T.)
        @ 2,19 GET mdata2 PICT '99/99/99' VALID IF(mdata2 < mdata1 ,.F.,.T.)
        @ 3,19 GET marq PICT '@S40@'
        READ
        IF LASTKEY() = 27
                CLOSE ALL
                SET CENTURY OFF
                wvw_lclosewindow()
                RETURN NIL
        ENDIF
        opcao := op_simnao('S','Confirma o periodo:')
        SET DEVI TO PRINT;SET PRINT ON
        SET PRINT TO (marq)
        SETPRC(00,00)
        mqtd_990 ++
        mqtd_9900 ++
        DEVPOS(PROW(),00);DEVOUT('|0000|008|0|')
        DEVPOS(PROW(),PCOL());DEVOUT(STRTRAN(DTOC(mdata1),'/','')+'|'+STRTRAN(DTOC(mdata2),'/','')+'|')
        DEVPOS(PROW(),PCOL());DEVOUT(ALLTRIM(m_set[1,129])+'|')
        DEVPOS(PROW(),PCOL());DEVOUT(SUBSTR(mcgc_firm,1,2)+SUBSTR(mcgc_firm,4,3)+SUBSTR(mcgc_firm,8,3)+SUBSTR(mcgc_firm,12,4)+SUBSTR(mcgc_firm,17,2)+'|')
        DEVPOS(PROW(),PCOL());DEVOUT('|')
        DEVPOS(PROW(),PCOL());DEVOUT(ALLTRIM(m_set[1,19])+'|')
        DEVPOS(PROW(),PCOL());DEVOUT(ALLTRIM(m_set[1,128])+'|')
        mcons_cid := {}
        sr_getconnection():exec("SELECT * FROM saccid WHERE cidade = "+sr_cdbvalue(RTRIM(m_set[1,134]))+" AND uf = "+sr_cdbvalue(RTRIM(m_set[1,19])),,.t.,@mcons_cid)
        IF LEN(mcons_cid) > 0
                DEVPOS(PROW(),PCOL());DEVOUT(ALLTRIM(mcons_cid[1,1])+'|')
        ELSE
                DEVPOS(PROW(),PCOL());DEVOUT('||')
        ENDIF
        DEVPOS(PROW(),PCOL());DEVOUT(IF(EMPTY(ALLTRIM(m_set[1,156])),'ISENTO',ALLTRIM(m_set[1,156]))+'|')
        DEVPOS(PROW(),PCOL());DEVOUT('|A|1|')        
        
        mqtd_990 ++
        mqtd_9900 ++
        DEVPOS(PROW()+1,0);DEVOUT('|0001|0|')

        mqtd_990 ++
        mqtd_9900 ++
        DEVPOS(PROW()+1,0);DEVOUT('|0005|')
        DEVPOS(PROW(),PCOL());DEVOUT(ALLTRIM(m_set[1,130])+'|')
        DEVPOS(PROW(),PCOL());DEVOUT(ALLTRIM(m_set[1,135])+'|')
        DEVPOS(PROW(),PCOL());DEVOUT(ALLTRIM(m_set[1,132])+'|')
        DEVPOS(PROW(),PCOL());DEVOUT(ALLTRIM(m_set[1,160])+'|')
        DEVPOS(PROW(),PCOL());DEVOUT(ALLTRIM(STRZERO(VAL(m_set[1,161]),10))+'|')
        DEVPOS(PROW(),PCOL());DEVOUT(ALLTRIM(m_set[1,133])+'|')
        DEVPOS(PROW(),PCOL());DEVOUT(ALLTRIM(m_set[1,136])+'|')
        DEVPOS(PROW(),PCOL());DEVOUT('|')
        DEVPOS(PROW(),PCOL());DEVOUT(ALLTRIM(m_set[1,137])+'|')

        mcons_emi := {}
        sr_getconnection():exec("SELECT * FROM saccid WHERE cidade = "+sr_cdbvalue(RTRIM(m_set[1,134]))+" AND uf = "+sr_cdbvalue(RTRIM(m_set[1,19])),,.t.,@mcons_emi)
        IF LEN(mcons_emi) = 0 .OR. EMPTY(mcons_emi[1,1])
                atencao('Nao e Possivel encontrar o codigo da cidade: '+RTRIM(m_set[1,167])+' nao estar cadastrado !!!!')
                wvw_lclosewindow()
                RETURN NIL
        ENDIF
        mcod_cid_emit := mcons_emi[1,1]

        mcons_cont := {}
        sr_getconnection():exec("SELECT * FROM sacsef ",,.t.,@mcons_cont)
        IF LEN(mcons_cont) = 0
                atencao('Nao existe nenhum contador cadastrado !!!!')
                wvw_lclosewindow()
                RETURN NIL
        ENDIF

        mqtd_990 ++
        mqtd_9900 ++
        DEVPOS(PROW()+1,0);DEVOUT('|0100|'+ALLTRIM(mcons_cont[1,1])+'|'+ALLTRIM(mcons_cont[1,2])+'|'+ALLTRIM(mcons_cont[1,3])+'||'+ALLTRIM(' ')+'|'+ALLTRIM(mcons_cont[1,9])+'|'+ALLTRIM(mcons_cont[1,10])+'|'+ALLTRIM(mcons_cont[1,11])+'|'+ALLTRIM(mcons_cont[1,12])+'|'+ALLTRIM(mcons_cont[1,4])+'|'+ALLTRIM(mcons_cont[1,6])+'|'+ALLTRIM(mcons_cont[1,8])+'|'+ALLTRIM(mcod_cid_emit)+'|')

        mqtd_9900 ++
        mcli_mov := {}
        sr_getconnection():exec("SELECT cod_cli FROM sactotnt WHERE ent_sai = 'S' AND emissao >= "+sr_cdbvalue(mdata1)+" AND emissao <= "+sr_cdbvalue(mdata2)+" GROUP BY cod_cli,cod_cli",,.t.,@mcli_mov)
        IF LEN(mcli_mov) > 0
                i:=0
                FOR i = 1 TO LEN(mcli_mov)
                        cons_cli := {}
                        sr_getconnection():exec("SELECT cod_cli,razao,cgc,cpf,insc,endereco,numero,complemento,bairro,cidade,uf FROM saccli WHERE cod_cli = "+sr_cdbvalue(mcli_mov[i,1]),,.t.,@cons_cli)
                        IF LEN(cons_cli) = 0
                                LOOP
                        ENDIF
                        mensagem('Modulo: 0150 Cliente:'+STR(cons_cli[1,1],5)+'-'+cons_cli[1,2])
                        mqtd_150 ++
                        mqtd_990 ++
                        DEVPOS(PROW()+1,0);DEVOUT('|0150')
                        DEVPOS(PROW(),PCOL());DEVOUT('|'+STR(cons_cli[1,1],5))
                        DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(cons_cli[1,2]))
                        DEVPOS(PROW(),PCOL());DEVOUT('|01058')
                        //DEVPOS(PROW(),PCOL());DEVOUT('|'+IF(! EMPTY(cons_cli[1,3]),ALLTRIM(cons_cli[1,3]),ALLTRIM(cons_cli[1,4])))
                        DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(cons_cli[1,3]))
                        DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(cons_cli[1,4]))
                        DEVPOS(PROW(),PCOL());DEVOUT('|'+IF(ALLTRIM(cons_cli[1,5])='ISENTO','',ALLTRIM(cons_cli[1,5])))
                        DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(vercod_cid(cons_cli[1,10],cons_cli[1,11])))
                        DEVPOS(PROW(),PCOL());DEVOUT('|')
                        DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(cons_cli[1,6]))
                        DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(cons_cli[1,7]))
                        DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(cons_cli[1,8]))
                        DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(cons_cli[1,9])+'|')
                NEXT
        ELSE
                mqtd_990 ++
                DEVPOS(PROW()+1,0);DEVOUT('|0150|3|'+ALLTRIM(mrazao_HTI)+'|01058|'+ALLTRIM(mcnpj_HTI)+'|||2611606||'+ALLTRIM(mend_HTI)+'|'+ALLTRIM(mnum_HTI)+'|'+ALLTRIM(mcomp_HTI)+'|'+ALLTRIM(mbairro_HTI)+'|')
        ENDIF
        mqtd_9900 ++
        DEVPOS(PROW()+1,0);DEVOUT('|0190|KG|KILO|')
        DEVPOS(PROW()+1,0);DEVOUT('|0190|UN|UNIDADE|')
        DEVPOS(PROW()+1,0);DEVOUT('|0190|PC|PACOTE|')
        DEVPOS(PROW()+1,0);DEVOUT('|0190|LT|LATA|')
        DEVPOS(PROW()+1,0);DEVOUT('|0190|MT|METRO|')
        DEVPOS(PROW()+1,0);DEVOUT('|0190|FD|FRADO|')
        DEVPOS(PROW()+1,0);DEVOUT('|0190|CX|CAIXA|')
        mqtd_990 := mqtd_990 + 7


        mcons_cid := {}
        sr_getconnection():exec("SELECT codigo FROM sacmovnt WHERE ent_sai = 'S' AND emissao >= "+sr_cdbvalue(mdata1)+" AND emissao <= "+sr_cdbvalue(mdata2)+" GROUP BY codigo,codigo",,.t.,@mcons_cid)
        mqtd_9900 ++
        IF LEN(mcons_cid) > 0
                mqtd_200 := LEN(mcons_cid)
                i := 0
                FOR i = 1 TO LEN(mcons_cid)
                        mcli_mov := {}
                        sr_getconnection():exec("SELECT cod_merc,merc,cod_barr,unidade,nbm,isento,bebida FROM sacmerc WHERE cod_merc = "+sr_cdbvalue(mcli_mov[i,1]),,.t.,@mcli_mov)
                        IF LEN(mcons_cid) = 0
                                LOOP
                        ENDIF
                        mensagem('Modulo: 0200')
                        mqtd_990 ++
                        DEVPOS(PROW()+1,0);DEVOUT('|0200|')
                        DEVPOS(PROW(),PCOL());DEVOUT(ALLTRIM(mcli_mov[1,1])+'|')
                        DEVPOS(PROW(),PCOL());DEVOUT(ALLTRIM(mcli_mov[1,2])+'|')
                        DEVPOS(PROW(),PCOL());DEVOUT(ALLTRIM(mcli_mov[1,3])+'|')
                        DEVPOS(PROW(),PCOL());DEVOUT('|')
                        DEVPOS(PROW(),PCOL());DEVOUT(SUBSTR(mcli_mov[1,4],1,2)+'|')
                        DEVPOS(PROW(),PCOL());DEVOUT('00'+'|')
                        DEVPOS(PROW(),PCOL());DEVOUT(ALLTRIM(mcli_mov[1,5])+'|')
                        DEVPOS(PROW(),PCOL());DEVOUT('|')
                        DEVPOS(PROW(),PCOL());DEVOUT('87|')
                        DEVPOS(PROW(),PCOL());DEVOUT('|')
                        IF mcli_mov[1,6] = 'S'
                                DEVPOS(PROW(),PCOL());DEVOUT(ALLTRIM(TRANSFORM(0,'@E 99.99'))+'|')
                        ELSEIF mcli_mov[1,6] = 'F'
                                DEVPOS(PROW(),PCOL());DEVOUT(ALLTRIM(TRANSFORM(0,'@E 99.99'))+'|')
                        ELSEIF mcli_mov[1,6] = 'N' .AND. mcli_mov[1,7] = 0
                                DEVPOS(PROW(),PCOL());DEVOUT(ALLTRIM(TRANSFORM(17,'@E 99.99'))+'|')
                        ELSEIF mcli_mov[1,6] = 'N' .AND. mcli_mov[1,7] > 0
                                DEVPOS(PROW(),PCOL());DEVOUT(ALLTRIM(TRANSFORM(mcli_mov[1,7],'@E 99.99'))+'|')
                        ELSEIF mcli_mov[1,6] = 'I'
                                DEVPOS(PROW(),PCOL());DEVOUT(ALLTRIM(TRANSFORM(0,'@E 99.99'))+'|')
                        ELSE
                                DEVPOS(PROW(),PCOL());DEVOUT(ALLTRIM(TRANSFORM(17,'@E 99.99'))+'|')
                        ENDIF
                NEXT
        //ELSE
        //        DEVPOS(PROW(),PCOL());DEVOUT('|')
        ENDIF
        mqtd_9900 ++
        mcons_emi := {}
        sr_getconnection():exec("SELECT * FROM sacop WHERE sai_ent = 'S'",,.t.,@mcons_emi)
        IF LEN(mcons_emi) = 0 .OR. EMPTY(mcons_emi[1,1])
                atencao('Nao existe nenhum CFOP cadastrado !!!!')
                wvw_lclosewindow()
                RETURN NIL
        ELSE
                i:=0
                FOR i = 1 TO LEN(mcons_emi)
                        mqtd_400 ++
                        mqtd_990 ++
                        DEVPOS(PROW()+1,0);DEVOUT('|0400|'+ALLTRIM(mcons_emi[i,1])+'|'+ALLTRIM(mcons_emi[i,2])+'|')
                NEXT
        ENDIF
        mqtd_9900 ++
        DEVPOS(PROW()+1,0);DEVOUT('|0990|'+ALLTRIM(TRANSFORM(mqtd_990+1,'9999'+'|')))       //QTD DE LINHAS DO BLOCO 0

        mqtd_9900 ++
        DEVPOS(PROW()+1,0);DEVOUT('|C001|0|')
        mqtd_c := 1
        mcons_r4 := {}
        sr_getconnection():exec("SELECT * FROM r4 WHERE data_mov >= "+sr_cdbvalue(mdata1)+" AND data_mov <= "+sr_cdbvalue(mdata2),,.t.,@mcons_r4)
        IF LEN(mcons_r4) > 0
                i := 0
                mqtd_c100 := LEN(mcons_r4)
                FOR i = 1 TO LEN(mcons_r4)
                        mensagem('Cupom Fiscal Modulo: C100 Numero:'+mcons_r4[i,5])
                        mqtd_c ++
                        DEVPOS(PROW()+1,0);DEVOUT('|C100|1|0|3|01|00|5')
                        DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(mcons_r4[i,5]))
                        DEVPOS(PROW(),PCOL());DEVOUT('|'+SUBSTR(mcons_r4[i,7],7,2)+SUBSTR(mcons_r4[i,7],6,2)+SUBSTR(mcons_r4[i,7],1,4))
                        DEVPOS(PROW(),PCOL());DEVOUT('|'+SUBSTR(mcons_r4[i,7],7,2)+SUBSTR(mcons_r4[i,7],6,2)+SUBSTR(mcons_r4[i,7],1,4))
                        DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(TRANSFORM(VAL(mcons_r4[i,7])/100,'@E 999999.99')))
                        DEVPOS(PROW(),PCOL());DEVOUT('|0')
                        DEVPOS(PROW(),PCOL());DEVOUT('|0')
                        DEVPOS(PROW(),PCOL());DEVOUT('|0')
                        DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(TRANSFORM(VAL(mcons_r4[i,7])/100,'@E 999999.99')))
                        DEVPOS(PROW(),PCOL());DEVOUT('|9')
                        DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(TRANSFORM(0,'@E 999999.99')))
                        DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(TRANSFORM(0,'@E 999999.99')))
                        DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(TRANSFORM(0,'@E 999999.99')))
                        DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(TRANSFORM(0,'@E 999999.99')))
                        DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(TRANSFORM(0,'@E 999999.99')))
                        DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(TRANSFORM(0,'@E 999999.99')))
                        DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(TRANSFORM(0,'@E 999999.99')))
                        DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(TRANSFORM(0,'@E 999999.99')))
                        DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(TRANSFORM(0,'@E 999999.99')))
                        DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(TRANSFORM(0,'@E 999999.99')))
                        DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(TRANSFORM(0,'@E 999999.99')))
                        DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(TRANSFORM(0,'@E 999999.99'))+'|')
                        m_cst:={}
                        d_cst:={}
                        v_cst:={}
                        mcons_r5 := {}
                        sr_getconnection():exec("SELECT * FROM r5 WHERE CCF_CVC_CBP = "+sr_cdbvalue(mcons_r4[i,5]),,.t.,@mcons_r5)
                        IF LEN(mcons_r5) > 0
                                y := 0
                                mqtd_c170 := mqtd_c170 + LEN(mcons_r5)
                                FOR y = 1 TO LEN(mcons_r5)
                                        mcons_prod := {}
                                        sr_getconnection():exec("SELECT sittrib FROM sacmerc WHERE cod_merc = "+sr_cdbvalue(STRZERO(VAL(mcons_r5[y,8]),5)),,.t.,@mcons_prod)
                                        IF LEN(mcons_prod) = 0
                                                LOOP
                                        ENDIF
                                        mqtd_c ++
                                        DEVPOS(PROW()+1,0);DEVOUT('|C170')
                                        DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(mcons_r5[y,7]))
                                        DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(mcons_r5[y,8]))
                                        DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(mcons_r5[y,9]))
                                        DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(TRANSFORM(VAL(mcons_r5[y,7])/1000,'@E 999999.99999')))
                                        DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(mcons_r5[y,11]))
                                        DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(TRANSFORM(VAL(mcons_r5[y,12])/100,'@E 999999.99')))
                                        DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(TRANSFORM(VAL(mcons_r5[y,13])/100,'@E 999999.99')))
                                        DEVPOS(PROW(),PCOL());DEVOUT('|0')
                                        DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(mcons_prod[1,1]))
                                        DEVPOS(PROW(),PCOL());DEVOUT('|5102')
                                        DEVPOS(PROW(),PCOL());DEVOUT('|5102')
                                        DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(TRANSFORM(0,'@E 999999.99')))
                                        DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(TRANSFORM(0,'@E 999999.99')))
                                        DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(TRANSFORM(0,'@E 999999.99')))
                                        DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(TRANSFORM(0,'@E 999999.99')))
                                        DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(TRANSFORM(0,'@E 999999.99')))
                                        DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(TRANSFORM(0,'@E 999999.99')))
                                        DEVPOS(PROW(),PCOL());DEVOUT('|0')
                                        DEVPOS(PROW(),PCOL());DEVOUT('|53|0|0,00|0,00|01||||||01||||||1|')
                                        mpt := ASCAN(v_cst,mcons_prod[1,1])
                                        IF mpt = 0
                                                AADD(d_cst,{mcons_prod[1,1],'|5102|0,00|',VAL(mcons_r5[y,13])/100,'|0,00|0,00|0,00|0,00|0,00|0,00||'})
                                                AADD(v_cst,mcons_prod[1,1])
                                        ELSE
                                                d_cst[mpt,3] := d_cst[mpt,3] + VAL(mcons_r5[y,13])/100
                                        ENDIF
                                NEXT
                                y := 0
                                mqtd_c190 := mqtd_c190 + LEN(d_cst)
                                FOR y = 1 TO LEN(d_cst)
                                        mqtd_c ++
                                        DEVPOS(PROW()+1,0);DEVOUT('|C190')
                                        DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(d_cst[Y,1]))
                                        DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(d_cst[Y,2]))
                                        DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(TRANSFORM(d_cst[Y,3],'@E 999999.99')))
                                        DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(d_cst[Y,4])+'|')
                                NEXT

                        ENDIF                
                NEXT
        ENDIF

        mcons_r4 := {}
        sr_getconnection():exec("SELECT * FROM sactotnt WHERE ent_sai = 'S' AND emissao >= "+sr_cdbvalue(mdata1)+" AND emissao <= "+sr_cdbvalue(mdata2),,.t.,@mcons_r4)
        IF LEN(mcons_r4) > 0
                //atencao(strzero(len(mcons_r4),5))
                i := 0
                mqtd_c100 := mqtd_c100 + LEN(mcons_r4)
                FOR i = 1 TO LEN(mcons_r4)
                        mensagem('Cupom NFE Modulo: C100 Numero:'+mcons_r4[i,5])
                        mqtd_c ++
                        DEVPOS(PROW()+1,0);DEVOUT('|C100')
                        DEVPOS(PROW(),PCOL());DEVOUT('|'+IF(mcons_r4[i,11]='E','0','1'))
                        DEVPOS(PROW(),PCOL());DEVOUT('|0')
                        DEVPOS(PROW(),PCOL());DEVOUT('|'+STR(mcons_r4[i,12],5))
                        DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(mcons_r4[i,7]))
                        DEVPOS(PROW(),PCOL());DEVOUT('|'+IF(mcons_r4[i,37]='C','02','00'))
                        DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(mcons_r4[i,6]))
                        DEVPOS(PROW(),PCOL());DEVOUT('|'+STRZERO(VAL(SUBSTR(mcons_r4[i,5],3)),9))
                        DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(mcons_r4[i,45]))
                        DEVPOS(PROW(),PCOL());DEVOUT('|'+STRTRAN(DTOC(mcons_r4[i,10]),'/',''))
                        DEVPOS(PROW(),PCOL());DEVOUT('|'+STRTRAN(DTOC(mcons_r4[i,10]),'/',''))
                        DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(TRANSFORM(mcons_r4[i,27],'@E 999999.99')))
                        DEVPOS(PROW(),PCOL());DEVOUT('|1')
                        DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(TRANSFORM(0,'@E 999999.99')))
                        DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(TRANSFORM(0,'@E 999999.99')))
                        DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(TRANSFORM(mcons_r4[i,28],'@E 999999.99')))
                        DEVPOS(PROW(),PCOL());DEVOUT('|9')
                        DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(TRANSFORM(0,'@E 999999.99')))
                        DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(TRANSFORM(0,'@E 999999.99')))
                        DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(TRANSFORM(mcons_r4[i,34],'@E 999999.99')))
                        DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(TRANSFORM(mcons_r4[i,20],'@E 999999.99')))
                        DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(TRANSFORM(mcons_r4[i,21],'@E 999999.99')))
                        DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(TRANSFORM(0,'@E 999999.99')))
                        DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(TRANSFORM(0,'@E 999999.99')))
                        DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(TRANSFORM(0,'@E 999999.99')))
                        DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(TRANSFORM(0,'@E 999999.99')))
                        DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(TRANSFORM(0,'@E 999999.99')))
                        DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(TRANSFORM(0,'@E 999999.99')))
                        DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(TRANSFORM(0,'@E 999999.99'))+'|')
                        m_cst:={}
                        d_cst:={}

                        mcons_r5 := {}
                        sr_getconnection():exec("SELECT * FROM sacmovnt WHERE documento = "+sr_cdbvalue(mcons_r4[i,5])+" AND cod_cli = "+sr_cdbvalue(mcons_r4[i,12]),,.t.,@mcons_r5)
                        IF LEN(mcons_r5) > 0
                                y := 0
                                mqtd_c170 := mqtd_c170 + LEN(mcons_r5)
                                FOR y = 1 TO LEN(mcons_r5)
                                        mqtd_c ++
                                        DEVPOS(PROW()+1,0);DEVOUT('|C170')
                                        DEVPOS(PROW(),PCOL());DEVOUT('|'+STRZERO(y,3))
                                        DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(mcons_r5[y,11]))
                                        DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(mcons_r5[y,12]))
                                        DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(TRANSFORM(mcons_r5[y,19],'@E 999999.99999')))
                                        DEVPOS(PROW(),PCOL());DEVOUT('|'+SUBSTR(mcons_r5[y,16],1,2))
                                        DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(TRANSFORM(mcons_r5[y,19]*mcons_r5[y,22],'@E 999999.99')))
                                        DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(TRANSFORM(0,'@E 999999.99')))
                                        DEVPOS(PROW(),PCOL());DEVOUT('|0')
                                        DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(mcons_r5[y,61])) //CST
                                        DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(STRTRAN(mcons_r5[y,65],'.',''))) //CFOP
                                        DEVPOS(PROW(),PCOL());DEVOUT('|') //COD. NATUREZA DA OPERACAO
                                        DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(TRANSFORM(mcons_r5[y,81],'@E 999999.99')))     //BASE ICMS
                                        DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(TRANSFORM(mcons_r5[y,38],'@E 999.99')))        //ALIQ ICMS
                                        DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(TRANSFORM(mcons_r5[y,80],'@E 999999.99')))     //VLR ICMS
                                        DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(TRANSFORM(0,'@E 999999.99')))                  //BASE ICMS ST
                                        DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(TRANSFORM(0,'@E 999999.99')))                  //ALIQ ICMS ST
                                        DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(TRANSFORM(0,'@E 999999.99')))                  //VLR ICMS ST
                                        DEVPOS(PROW(),PCOL());DEVOUT('|')       //IND APURACAO
                                        DEVPOS(PROW(),PCOL());DEVOUT('|')       //CST IPI
                                        DEVPOS(PROW(),PCOL());DEVOUT('|')       //COD ENQ
                                        DEVPOS(PROW(),PCOL());DEVOUT('|0,00')   // BASE IPI
                                        DEVPOS(PROW(),PCOL());DEVOUT('|0,00')   // ALIQ IPI
                                        DEVPOS(PROW(),PCOL());DEVOUT('|0,00')   // VLR IPI
                                        DEVPOS(PROW(),PCOL());DEVOUT('|70')     // CST PIS
                                        DEVPOS(PROW(),PCOL());DEVOUT('|0,00')   // BASE PIS
                                        DEVPOS(PROW(),PCOL());DEVOUT('|0,0000')  // QTD BASE PIS
                                        DEVPOS(PROW(),PCOL());DEVOUT('|0,000') // ALIQ PIS
                                        DEVPOS(PROW(),PCOL());DEVOUT('|0,0000') // ALIQ PIS
                                        DEVPOS(PROW(),PCOL());DEVOUT('|0,00')   // VLR PIS
                                        DEVPOS(PROW(),PCOL());DEVOUT('|99')     // CST CONFIS
                                        DEVPOS(PROW(),PCOL());DEVOUT('|0,00')   // BASE CONFIS
                                        DEVPOS(PROW(),PCOL());DEVOUT('|0,0000')  // QTD BASE CONFIS
                                        DEVPOS(PROW(),PCOL());DEVOUT('|0,000') // ALIQ CONFIS
                                        DEVPOS(PROW(),PCOL());DEVOUT('|0,0000') // ALIQ PIS
                                        DEVPOS(PROW(),PCOL());DEVOUT('|0,00')   // VLR CONFIS
                                        DEVPOS(PROW(),PCOL());DEVOUT('||')       //CONTA CONTABIL
                                NEXT
                        ENDIF
                                */
                        mcons_cst := {}
                        sr_getconnection():exec("SELECT sittrib,cod_nat,icm,sum(quantd * vl_fatura),sum(base_icm),sum(vlr_icm) FROM sacmovnt WHERE documento = "+sr_cdbvalue(mcons_r4[i,5])+" AND cod_cli = "+sr_cdbvalue(mcons_r4[i,12])+" GROUP BY icm,icm,sittrib,sittrib,cod_nat,cod_nat",,.t.,@mcons_cst)
                        IF LEN(mcons_cst) > 0
                                y := 0
                                mqtd_c190 := mqtd_c190 + LEN(mcons_cst)
                                mqtd_c := mqtd_c + LEN(mcons_cst)
                                FOR y = 1 TO LEN(mcons_cst)
                                        DEVPOS(PROW()+1,0);DEVOUT('|C190')
                                        DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(mcons_cst[Y,1]))
                                        DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(STRTRAN(mcons_cst[Y,2],'.','')))
                                        DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(TRANSFORM(mcons_cst[Y,3],'@E 999999.99')))
                                        DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(TRANSFORM(mcons_cst[Y,4],'@E 999999.99')))
                                        DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(TRANSFORM(mcons_cst[Y,5],'@E 999999.99')))
                                        DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(TRANSFORM(mcons_cst[Y,6],'@E 999999.99')))
                                        DEVPOS(PROW(),PCOL());DEVOUT('|0,00')
                                        DEVPOS(PROW(),PCOL());DEVOUT('|0,00')
                                        DEVPOS(PROW(),PCOL());DEVOUT('|0,00')
                                        DEVPOS(PROW(),PCOL());DEVOUT('|0,00')
                                        DEVPOS(PROW(),PCOL());DEVOUT('|')
                                        DEVPOS(PROW(),PCOL());DEVOUT('|')
                                NEXT
                        ENDIF

                NEXT
        ENDIF
        mqtd_9900 := mqtd_9900 + 3

        mcons_d1 := {}
        sr_getconnection():exec("SELECT * FROM d1 WHERE data_doc >= "+sr_cdbvalue(mdata1)+" AND data_doc <= "+sr_cdbvalue(mdata2),,.t.,@mcons_d1)
        mqtd_9900 ++
        mqtd_9900 ++
        mqtd_9900 ++
        IF LEN(mcons_d1) > 0
                mqtd_c ++
                mqtd_c350 ++
                DEVPOS(PROW()+1,0);DEVOUT('|C350')
                DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(mcons_d1[1,2]))
                DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(mcons_d1[1,3]))
                DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(mcons_d1[1,4]))
                DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(STRTRAN(DTOC(mcons_d1[1,1]),'/','')))
                DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(mcons_d1[1,5]))
                DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(TRANSFORM(mcons_d1[1,13]*100,'9999999999999')))
                DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(TRANSFORM(mcons_d1[1,14]*100,'9999999999999')))
                DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(TRANSFORM(mcons_d1[1,15]*100,'9999999999999')))
                DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(TRANSFORM(mcons_d1[1,16]*100,'9999999999999')))
                DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(TRANSFORM(mcons_d1[1,17]*100,'9999999999999')))
                DEVPOS(PROW(),PCOL());DEVOUT('|1|')
                i := 0
                d_cst := {}
                m_cst := {}
                mqtd_c370 := mqtd_c370 + LEN(mcons_d1)
                FOR i = 1 TO LEN(mcons_d1)
                        mqtd_c ++
                        DEVPOS(PROW()+1,0);DEVOUT('|C370')
                        DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(TRANSFORM(VAL(mcons_d1[i,6]),'999')))
                        DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(mcons_d1[i,7]))
                        DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(TRANSFORM(mcons_d1[i,8]/1000,'99999999999')))
                        DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(mcons_d1[i,9]))
                        DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(TRANSFORM(mcons_d1[i,12]/100,'99999999999')))
                        DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(TRANSFORM(mcons_d1[i,11]/100,'99999999999')))
                        mpt := ASCAN(v_cst,mcons_d1[i,18])
                        IF mpt = 0
                                AADD(d_cst,{mcons_d1[i,18],mcons_d1[i,8] * mcons_d1[i,12],mcons_d1[i,19],mcons_d1[i,20]})
                                AADD(v_cst,mcons_d1[i,18])
                        ELSE
                                d_cst[mpt,3] := d_cst[mpt,2] + (mcons_d1[i,8] * mcons_d1[i,12])
                        ENDIF
                NEXT
                y := 0
                mqtd_c390 := mqtd_c390 + LEN(d_cst)
                FOR y = 1 TO LEN(d_cst)
                        mqtd_c ++
                        DEVPOS(PROW()+1,0);DEVOUT('|C390')
                        DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(d_cst[Y,1]))
                        DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(d_cst[Y,3]))
                        DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(d_cst[Y,4]))
                        DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(TRANSFORM(d_cst[Y,2],'@E 999999.99')))
                        DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(TRANSFORM(0,'@E 999999.99')))
                        DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(TRANSFORM(0,'@E 999999.99')))
                        DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(TRANSFORM(0,'@E 999999.99')))
                        DEVPOS(PROW(),PCOL());DEVOUT('|1|')
                NEXT

        ENDIF
        mcons_r4 := {}
        sr_getconnection():exec("SELECT * FROM r4 WHERE data_mov >= "+sr_cdbvalue(mdata1)+" AND data_mov <= "+sr_cdbvalue(mdata2),,.t.,@mcons_r4)
        mqtd_9900 ++
        IF LEN(mcons_r4) > 0
                mqtd_c ++
                mqtd_c400 ++
                DEVPOS(PROW()+1,0);DEVOUT('|C400')
                DEVPOS(PROW(),PCOL());DEVOUT('|2D')
                DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(mcons_r4[1,3]))
                DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(mcons_r4[1,1]))
                DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(mcons_r4[1,4])+'|')
        ENDIF
        mcons_r2 := {}
        sr_getconnection():exec("SELECT * FROM r2 WHERE data_mov >= "+sr_cdbvalue(mdata1)+" AND data_mov <= "+sr_cdbvalue(mdata2),,.t.,@mcons_r2)
        IF LEN(mcons_r2) > 0
                i := 0
                mqtd_c405 := LEN(mcons_r2)
                FOR i = 1 TO LEN(mcons_r2)
                        mqtd_c ++
                        DEVPOS(PROW()+1,0);DEVOUT('|C405')
                        DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(STRTRAN(DTOC(mcons_r2[i,14]),'/','')))
                        DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(mcons_r2[i,7]))
                        DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(mcons_r2[i,5]))
                        DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(mcons_r2[i,6]))
                        //DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(TRANSFORM(VAL(mcons_r2[i,14])/100,'@E 9999999999.99')))
                        DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(TRANSFORM(VAL(mcons_r2[i,10])/100,'@E 9999999999.99'))+'|')
                        DEVPOS(PROW()+1,0);DEVOUT('|C410|0,00|0,00|')
                        mcons_r3 := {}
                        sr_getconnection():exec("SELECT * FROM r3 WHERE crz = "+sr_cdbvalue(mcons_r2[i,5]),,.t.,@mcons_r3)
                        IF LEN(mcons_r3) > 0
                                mqtd_c420 := mqtd_c420 + LEN(mcons_r3)
                                y := 0
                                FOR y = 1 TO LEN(mcons_r3)
                                        mqtd_c ++
                                        DEVPOS(PROW()+1,0);DEVOUT('|C420')
                                        DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(mcons_r3[y,6]))
                                        DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(TRANSFORM(VAL(mcons_r3[y,7])/100,'@E 9999999999.99')))
                                        DEVPOS(PROW(),PCOL());DEVOUT('|||')
                                NEXT
                        ENDIF
                NEXT
        ENDIF
        mqtd_9900 := mqtd_9900 + 3

        IF LEN(mcons_r4) > 0
                        mapuracao := 0
                        mqtd_c ++
                        DEVPOS(PROW()+1,0);DEVOUT('|C460|2D|00')
                        DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(mcons_r4[1,6]))
                        DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(STRTRAN(DTOC(mcons_r4[1,19]),'/','')))
                        DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(TRANSFORM(VAL(mcons_r4[1,13])/100,'@E 999,999.99')))
                        DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(TRANSFORM(0,'@E 999999.99')))
                        DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(TRANSFORM(0,'@E 999999.99')))
                        DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(mcons_r4[1,18]))
                        DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(mcons_r4[1,18])+'|')
                        m_cst:={}
                        d_cst:={}
                        mcons_r5 := {}
                        sr_getconnection():exec("SELECT * FROM r5 WHERE coo = "+sr_cdbvalue(mcons_r4[1,6]),,.t.,@mcons_r5)
                        IF LEN(mcons_r5) > 0
                                mqtd_c470 := mqtd_c470 + LEN(mcons_r5)
                                y := 0
                                FOR y = 1 TO LEN(mcons_r5)
                                        mcons_prod := {}
                                        sr_getconnection():exec("SELECT sittrib FROM sacmerc WHERE cod_merc = "+sr_cdbvalue(STRZERO(VAL(mcons_r5[y,8]),5)),,.t.,@mcons_prod)
                                        IF LEN(mcons_prod) = 0
                                                LOOP
                                        ENDIF
                                        mqtd_c ++
                                        DEVPOS(PROW()+1,0);DEVOUT('|C470')
                                        DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(mcons_r5[y,8]))
                                        DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(mcons_r5[y,9]))
                                        DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(TRANSFORM(VAL(mcons_r5[y,10])/1000,'@E 999999.999')))
                                        DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(TRANSFORM(VAL(mcons_r5[y,18])/1000,'@E 999999.999')))
                                        DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(mcons_r5[y,11]))
                                        DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(TRANSFORM(VAL(mcons_r5[y,15])/100,'@E 999999.99')))
                                        DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(mcons_prod[1,1]))
                                        DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM('5102'))
                                        DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(TRANSFORM(mcons_prod[1,13]/100,'@E 999999.99')))
                                        DEVPOS(PROW(),PCOL());DEVOUT('|||')
                                        mpt := ASCAN(v_cst,mcons_prod[1,1])
                                        IF mpt = 0
                                                AADD(d_cst,{mcons_prod[1,1],'5102',mcons_prod[1,13],(VAL(mcons_r5[y,10]) * VAL(mcons_r5[y,15]))})
                                                AADD(v_cst,mcons_prod[1,1])
                                        ELSE
                                                d_cst[mpt,3] := d_cst[mpt,4] + (VAL(mcons_r5[y,10]) * VAL(mcons_r5[y,15]))
                                        ENDIF
                                NEXT
                                mqtd_c490 := mqtd_c490 + LEN(d_cst)
                                y := 0
                                FOR y = 1 TO LEN(d_cst)
                                        mqtd_c ++
                                        DEVPOS(PROW()+1,0);DEVOUT('|C490')
                                        DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(d_cst[y,1]))
                                        DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(d_cst[y,2]))
                                        DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(TRANSFORM(d_cst[y,3],'@E 999999.99')))
                                        DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(TRANSFORM(d_cst[y,4]/100,'@E 999999.99')))
                                        DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(TRANSFORM(d_cst[y,4]*(d_cst[y,3]/100),'@E 999999.99'))+'||')
                                        mapuracao := mapuracao + (d_cst[Y,4]*(d_cst[Y,3]/100))
                                NEXT

                        ENDIF                
        ENDIF
        mqtd_9900 := mqtd_9900 + 3
        mqtd_c ++
        mqtd_9900 ++
        DEVPOS(PROW()+1,0);DEVOUT('|C990|'+ALLTRIM(TRANSFORM(mqtd_c,'@E 99999999'))+'|')
        mqtd_9900 ++
        DEVPOS(PROW()+1,0);DEVOUT('|D001|1|')
        mqtd_9900 ++
        DEVPOS(PROW()+1,0);DEVOUT('|D990|2|')
        mqtd_9900 ++
        DEVPOS(PROW()+1,0);DEVOUT('|E001|0|')
        //DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(TRANSFORM(mqtd_c,'@E 99999999'))+'|')
        mqtd_9900 ++
        DEVPOS(PROW()+1,0);DEVOUT('|E100|'+ALLTRIM(STRTRAN(DTOC(mdata1),'/',''))+'|'+ALLTRIM(STRTRAN(DTOC(mdata2),'/',''))+'|')
        mqtd_9900 ++
        DEVPOS(PROW()+1,0);DEVOUT('|E110|0,00|0,00|0,00|0,00|0,00|0,00|0,00|0,00|0,00|0,00|0,00|0,00|0,00|0,00|')
        //DEVPOS(PROW(),PCOL());DEVOUT('|'+ALLTRIM(TRANSFORM(mapuracao,'@E 999999.99'))+'|0|0|0|0|0|0|0|0|'+ALLTRIM(TRANSFORM(mapuracao,'@E 999999.99'))+'|0|'+ALLTRIM(TRANSFORM(mapuracao,'@E 999999.99'))+'|0|0|')
        mqtd_9900 ++
        DEVPOS(PROW()+1,0);DEVOUT('|E990|4|')
        mqtd_9900 ++
        DEVPOS(PROW()+1,0);DEVOUT('|G001|1|')
        mqtd_9900 ++
        DEVPOS(PROW()+1,0);DEVOUT('|G990|2|')
        mqtd_9900 ++
        DEVPOS(PROW()+1,0);DEVOUT('|H001|1|')
        mqtd_9900 ++
        DEVPOS(PROW()+1,0);DEVOUT('|H990|2|')
        mqtd_9900 ++
        DEVPOS(PROW()+1,0);DEVOUT('|1001|0|')
        mqtd_9900 ++
        DEVPOS(PROW()+1,0);DEVOUT('|1010|N|N|N|N|N|N|N|N|N|')
        mqtd_9900 ++
        DEVPOS(PROW()+1,0);DEVOUT('|1990|3|')
        DEVPOS(PROW()+1,0);DEVOUT('|9001|0|')
        DEVPOS(PROW()+1,0);DEVOUT('|9900|0000|1|')
        DEVPOS(PROW()+1,0);DEVOUT('|9900|0001|1|')
        DEVPOS(PROW()+1,0);DEVOUT('|9900|0005|1|')
        DEVPOS(PROW()+1,0);DEVOUT('|9900|0100|1|')
        DEVPOS(PROW()+1,0);DEVOUT('|9900|1010|1|')
        DEVPOS(PROW()+1,0);DEVOUT('|9900|0150|'+ALLTRIM(TRANSFORM(mqtd_150,'99999'))+'|')
        DEVPOS(PROW()+1,0);DEVOUT('|9900|0190|7|')
        DEVPOS(PROW()+1,0);DEVOUT('|9900|0200|'+ALLTRIM(TRANSFORM(mqtd_200,'99999'))+'|')
        DEVPOS(PROW()+1,0);DEVOUT('|9900|0400|'+ALLTRIM(TRANSFORM(mqtd_400,'99999'))+'|')
        DEVPOS(PROW()+1,0);DEVOUT('|9900|0990|1|')
        DEVPOS(PROW()+1,0);DEVOUT('|9900|C001|1|')
        DEVPOS(PROW()+1,0);DEVOUT('|9900|C100|'+ALLTRIM(TRANSFORM(mqtd_c100,'99999'))+'|')
        DEVPOS(PROW()+1,0);DEVOUT('|9900|C170|'+ALLTRIM(TRANSFORM(mqtd_c170,'99999'))+'|')
        DEVPOS(PROW()+1,0);DEVOUT('|9900|C190|'+ALLTRIM(TRANSFORM(mqtd_c190,'99999'))+'|')
        DEVPOS(PROW()+1,0);DEVOUT('|9900|C350|'+ALLTRIM(TRANSFORM(mqtd_c350,'99999'))+'|')
        DEVPOS(PROW()+1,0);DEVOUT('|9900|C370|'+ALLTRIM(TRANSFORM(mqtd_c370,'99999'))+'|')
        DEVPOS(PROW()+1,0);DEVOUT('|9900|C390|'+ALLTRIM(TRANSFORM(mqtd_c390,'99999'))+'|')
        DEVPOS(PROW()+1,0);DEVOUT('|9900|C400|'+ALLTRIM(TRANSFORM(mqtd_C400,'99999'))+'|')
        DEVPOS(PROW()+1,0);DEVOUT('|9900|C405|'+ALLTRIM(TRANSFORM(mqtd_c405,'99999'))+'|')
        DEVPOS(PROW()+1,0);DEVOUT('|9900|C420|'+ALLTRIM(TRANSFORM(mqtd_c420,'99999'))+'|')
        DEVPOS(PROW()+1,0);DEVOUT('|9900|C470|'+ALLTRIM(TRANSFORM(mqtd_c470,'99999'))+'|')
        DEVPOS(PROW()+1,0);DEVOUT('|9900|C490|'+ALLTRIM(TRANSFORM(mqtd_c490,'99999'))+'|')
        DEVPOS(PROW()+1,0);DEVOUT('|9900|C990|1|')
        DEVPOS(PROW()+1,0);DEVOUT('|9900|D001|1|')
        DEVPOS(PROW()+1,0);DEVOUT('|9900|D990|1|')
        DEVPOS(PROW()+1,0);DEVOUT('|9900|E001|1|')
        DEVPOS(PROW()+1,0);DEVOUT('|9900|E100|1|')
        DEVPOS(PROW()+1,0);DEVOUT('|9900|E110|1|')
        DEVPOS(PROW()+1,0);DEVOUT('|9900|E990|1|')
        DEVPOS(PROW()+1,0);DEVOUT('|9900|H001|1|')
        DEVPOS(PROW()+1,0);DEVOUT('|9900|H990|1|')
        DEVPOS(PROW()+1,0);DEVOUT('|9900|G001|1|')
        DEVPOS(PROW()+1,0);DEVOUT('|9900|G990|1|')
        DEVPOS(PROW()+1,0);DEVOUT('|9900|1001|1|')
        DEVPOS(PROW()+1,0);DEVOUT('|9900|1990|1|')
        DEVPOS(PROW()+1,0);DEVOUT('|9900|9001|1|')
        DEVPOS(PROW()+1,0);DEVOUT('|9900|9900|39|')
        DEVPOS(PROW()+1,0);DEVOUT('|9900|9990|1|')
        DEVPOS(PROW()+1,0);DEVOUT('|9900|9999|1|')
        DEVPOS(PROW()+1,0);DEVOUT('|9990|42|')
        DEVPOS(PROW()+1,0);DEVOUT('|9999|'+ALLTRIM(TRANSFORM(PROW()+1,'99999'))+'|')
        DEVPOS(PROW()+1,0);DEVOUT('')
        SET DEVI TO SCREEN;SET PRINT OFF;SET PRINT TO
        FCLOSE(marq)
        GERA_EAD(marq)
        IF 'S' = op_simnao('S','Deseja Editar o arquivo:')
                MYRUN('NOTEPAD '+ALLTRIM(marq))
        ENDIF
        EXIT
ENDDO
CLOSE ALL
SET CENTURY OFF
wvw_lclosewindow()
RETURN NIL
******************************* F I M *****************************************
