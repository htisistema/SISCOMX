* MENU DE REAJUSTE
***********************
MEMVAR getlist,nivel_acess,mdata_sis,cod_operado
FUNCTION sac27
**************
LOCAL MPRG:='SAC27',opcao:=0
setcor(1)
op_tela(10,10,23,75,' MANUTENCAO DOS PRODUTOS ')
WHILE .T.
        exibi_prg(mprg)
        mensagem('Escolha a Opcao que deseja')
        @ 0,0 PROMPT ' Reajuste Produto                                                '
        @ 1,0 PROMPT ' Reajuste (%) Cliente/Produto                                    '
        @ 2,0 PROMPT ' Reajuste de Mercad. p/Detalhe                                   '
        @ 3,0 PROMPT ' Ajustar o Saldo dos Produtos                                    '
        @ 4,0 PROMPT ' Calcular/Atualizar Estoque Minimo dos Produtos                  '
        @ 5,0 PROMPT ' Atualizar Local da Produto p/Fornecedor                         '
        @ 6,0 PROMPT ' AJUSTAR DE GRUPO E SUB-GRUPO DOS PRODUTOS NO MOVIMENTO E PEDIDOS'
        @ 7,0 PROMPT ' Promocao de Produtos (Colocar e Retirar)                        '
        @ 8,0 PROMPT ' Excluir Produtos com relacao da DATA DE SAIDA                   '
        @ 9,0 PROMPT ' Alterar produtos para ISENTO OU NAO por Grupo e Sub-Grupo       '
        @ 10,0 PROMPT ' Alterar a MARGEM DE LUCRO dos produtos                          '
        @ 11,0 PROMPT ' Verificar se existe PRODUTOS com codigos iguais                 '
        @ 12,0 PROMPT ' Ajustar Aliquota ICMS dos Produtos                              '
        SET INTEN ON
        MENU TO opcao
        IF LASTKEY() = 27
                wvw_lclosewindow()
                RETURN NIL
        ENDIF

        DO CASE
                CASE opcao = 1
                *        REAJUSTE DE MERCADORIA
                         sac271()
                CASE opcao = 2
                *        REAJUSTE DE % CLIENTE/MERCADORIA
                         sac272()
                CASE opcao = 3
                *        REAJUSTE DOS DETALHES DA MERCADORIA
                         sac273()
                CASE opcao = 4
                *        AJUSTAR SALDO DOS PRODUTOS
                         sac274()
                CASE opcao = 5
                *        CALCULAR ESTOQUE MINIMO
                         sac526('*')
                CASE opcao = 6
                *        ATUALIZAR O LOCAL DA MERCADORIA PELO FORNECEDOR
                         sac275()
                CASE opcao = 7
                *        AJUSTAR DE GRUPO E SUB-GRUPO DOS PRODUTOS NO MOVIMENTO E PEDIDOS
                         sac276()
                CASE opcao = 8
                *        PROMOCAO DE PRODUTOS
                         sac25()
                CASE opcao = 9
                *        EXCLUSAO DE PRODUTOS
                         sac277()
                CASE opcao = 10
                *        Alterar produtos para ISENTO OU NAO por Grupo e Sub-Grupo
                         sac278()
                CASE opcao = 11
                         sac279()
                CASE opcao = 12
                         sac280()
                CASE opcao = 13
                         sac281()
        ENDCASE
ENDDO
RETURN NIL
***************************** F I M ************************************
* REAJUSTE DE MERCADORIAS
*************************
FUNCTION sac271
***************
LOCAL MPRG:='SAC271',;
      tela,lba,cba,msub1,msub2,mgrupo1,mgrupo2,mcod_merc1,mcod_merc2,opcao,mquantd,;
      mperc,mvenda,venda2,mreal,mdata_r,mcust_merc,mprc_esp,maredonda:=0

PRIVATE mtraco,mcod_espe,mcod_fab,mcod_merc:=0,mtipo_imp,mimp_tipo:=0,marq:=SPACE(35)

IF ! ver_nivel(mprg,'REAJUSTE DE MERCADORIAS','15',nivel_acess,,'AMBIE')
        RETURN NIL
ENDIF
mtraco := REPLI('=',132)
lba := 22
cba := 75
*--------------------------------------------------------------------------
IF ! AbriArq('sacgrupo','grup');RETURN NIL;ENDIF
IF ! AbriArq('sacmerc','merc');RETURN NIL;ENDIF
IF ! AbriArq('sacespe','espe');RETURN NIL;ENDIF
IF ! AbriArq('sacforn','forn');RETURN NIL;ENDIF
*--------------------------------------------------------------------------
setcor(1)
op_tela(05,03,22,75,' Reajuste Mercadoria ')
WHILE .T.
********* VARIAVEIS DE IMPRESSAO *******************
        mtipo_imp := m_indiv[1,18]
****************************************************
        limpa(05,03,19,75)
        exibi_prg(mprg)
        msub1 = SPACE(2)
        mgrupo1 = SPACE(5)
        mperc := mcod_fab := mcod_espe := 0
        mvenda := 'X'
        mvenda2 := mvenda3 := mvenda4 := mvenda5 :=  mreal  := mcust_merc := mprc_esp  := ' '
        mdata_r := CTOD('  /  /  ')
        maredonda := 2
        mensagem('Preencha os Campos ou em Brnaco p/todos - <ESC>p/Abandonar')
        @ 6,0 TO 6,cba
        setcor(1)
        DEVPOS(1,2);DEVOUT('Cod.Produto....:')
        DEVPOS(2,2);DEVOUT('Cod.Grupo......:')
        DEVPOS(3,2);DEVOUT('Cod.Sub-Grupo..:')
        DEVPOS(4,2);DEVOUT('Cod.Especie....:')
        DEVPOS(5,2);DEVOUT('Cod.Fabricante.:')
        DEVPOS(7,2);DEVOUT('Preco de Venda 1:')
        DEVPOS(8,2);DEVOUT('Preco de Venda 2:')
        //DEVPOS(9,2);DEVOUT('Preco de Venda 3:')
        //DEVPOS(10,2);DEVOUT('Preco de Venda 4:')
        //DEVPOS(11,2);DEVOUT('Preco de Venda 5:')
        DEVPOS(12,2);DEVOUT('Preco Custo Real:')
        DEVPOS(13,2);DEVOUT('Preco Custo Merc:')
        DEVPOS(14,2);DEVOUT('Preco Especial..:')
        DEVPOS(15,2);DEVOUT('Produtos s/Alteracao no Prc.de Venda desde:')
        DEVPOS(16,2);DEVOUT('Percentual (%)..:')
        DEVPOS(16,27);DEVOUT('Arendondamento Casa Decimal:')
        ********************
        SELE('merc');ORDSETFOCUS(1)
        GO TOP
        ********************
        @ 1,19 GET mcod_merc PICT '99999' VALID ver_cod(mcod_merc,1,25,,0)
        @ 2,19 GET mgrupo1 PICT '999' VALID v_gru_cod(mgrupo1,2,2,23) WHEN EMPTY(mcod_merc)
        @ 3,19 GET msub1 PICT '99' WHEN ! EMPTY(mgrupo1) .AND. EMPTY(mcod_merc) VALID ver_sgru(VAL(ALLTRIM(mgrupo1)),VAL(msub1),3,23,.F.)  //v_gru_cod(mgrupo1 + msub1 + mcod_merc1,2)
        @ 4,19 GET mcod_espe PICT '9999' VALID ver_espe(mcod_espe,10,24,,0)  WHEN EMPTY(mcod_merc)
        @ 5,19 GET mcod_fab PICT '9999' VALID ver_fab(mcod_fab,11,24)  WHEN EMPTY(mcod_merc)
        @ 7,19 GET mvenda PICT '@!' VALID mvenda $ 'X, ' .AND. lim_get() WHEN men_get(13,19,'Assinale com um "X" p/reajustar ou deixe em branco p/NAO Reajustar')
        @ 8,19 GET mvenda2 PICT '@!' VALID mvenda2 $ 'X, ' .AND. lim_get() WHEN men_get(14,19,'Assinale com um "X" p/reajustar ou deixe em branco p/NAO Reajustar')
        //@ 9,19 GET mvenda3 PICT '@!' VALID mvenda3 $ 'X, ' .AND. lim_get() WHEN men_get(14,19,'Assinale com um "X" p/reajustar ou deixe em branco p/NAO Reajustar')
        //@ 10,19 GET mvenda4 PICT '@!' VALID mvenda4 $ 'X, ' .AND. lim_get() WHEN men_get(14,19,'Assinale com um "X" p/reajustar ou deixe em branco p/NAO Reajustar')
        //@ 11,19 GET mvenda5 PICT '@!' VALID mvenda5 $ 'X, ' .AND. lim_get() WHEN men_get(14,19,'Assinale com um "X" p/reajustar ou deixe em branco p/NAO Reajustar')
        @ 12,19 GET mreal PICT '@!' VALID mreal $ 'X, ' .AND. lim_get() WHEN men_get(15,19,'Assinale com um "X" p/reajustar ou deixe em branco p/NAO Reajustar')
        @ 13,19 GET mcust_merc PICT '@!' VALID mcust_merc $ 'X, ' .AND. lim_get() WHEN men_get(16,19,'Assinale com um "X" p/reajustar ou deixe em branco p/NAO Reajustar')
        @ 14,19 GET mprc_esp PICT '@!' VALID mprc_esp $ 'X, ' .AND. lim_get() WHEN men_get(17,19,'Assinale com um "X" p/reajustar ou deixe em branco p/NAO Reajustar')
        @ 15,46 GET mdata_r
        @ 16,19 GET mperc PICT '999.99' VALID IF(EMPTY(mperc),.F.,.T.)
        @ 16,56 GET maredonda PICT '9'
        READ
        IF LASTKEY() = 27
                RELEASE mtraco
                EXIT
        ENDIF
        IF EMPTY(mvenda) .AND. EMPTY(mvenda2) .AND. EMPTY(mreal) .AND. EMPTY(mprc_esp) .AND. EMPTY(mcust_merc)
                atencao('Nao foi marcado nenhum preco para ser reajustado')
                LOOP
        ENDIF
        opcao := op_simnao('S','Confirma o Reajuste:')
        IF opcao = 'N'
                LOOP
        ENDIF
        IF ! EMPTY(mcod_merc)
                IF mvenda = 'X'
                        merc-> pr_venda := iat(merc->pr_venda * ((mperc/100)+1),maredonda)
                        merc-> ul_alt_pr := mdata_sis
                        merc-> opera_pr := cod_operado
                ENDIF
                IF mvenda2 = 'X'
                        merc-> pr_venda1 := iat(merc->pr_venda1 * ((mperc/100)+1),maredonda)
                ENDIF
                IF mreal = 'X'
                        merc-> cust_real := iat(merc->cust_real * ((mperc/100)+1),maredonda)
                ENDIF
                IF mcust_merc = 'X'
                        merc-> cust_merc := iat(merc->cust_merc * ((mperc/100)+1),maredonda)
                ENDIF
                IF mprc_esp = 'X'
                        merc-> pr_fat := iat(merc->pr_fat * ((mperc/100)+1),maredonda)
                ENDIF
                merc-> data_atu := mdata_sis
                atencao('Foi feito o rejuste da Mercadoria com sucesso...')
                LOOP
        ENDIF
        IF EMPTY(mgrupo1) .AND. EMPTY(msub1)
                IF ! imp_arq('REAJUSTE.REL','R')
                        LOOP
                ENDIF
                ********************
                SELE('merc');ORDSETFOCUS(1)
                GO TOP
                ********************
                IF BLOQARQ()
                        mensagem('Espere o Final do Reajuste das Mercadorias !!!')
                        DEVPOS(PROW()+1,00);DEVOUT(mtraco)
                        DEVPOS(PROW()+1,00);DEVOUT('PRODUTO')
                        DEVPOS(PROW(),52);DEVOUT('Venda ANT.')
                        DEVPOS(PROW(),PCOL()+1);DEVOUT('Venda POS.')
                        DEVPOS(PROW(),PCOL()+1);DEVOUT('Venda2 ANT')
                        DEVPOS(PROW(),PCOL()+1);DEVOUT('Venda2 POS')
                        DEVPOS(PROW(),PCOL()+1);DEVOUT('Cus.REAL A')
                        DEVPOS(PROW(),PCOL()+1);DEVOUT('Cus.REAL P')
                        DEVPOS(PROW(),PCOL()+1);DEVOUT('Cus.MERC A')
                        DEVPOS(PROW(),PCOL()+1);DEVOUT('Cus.MERC P')
                        DEVPOS(PROW(),PCOL()+1);DEVOUT('Pr.Esp.ANT')
                        DEVPOS(PROW(),PCOL()+1);DEVOUT('Pr.Esp.POS')
                        DEVPOS(PROW()+1,00);DEVOUT(mtraco)
                        WHILE ! EOF()
                                prog_imp(RECNO(),merc->cod_merc+'-'+merc->merc)
                                IF (merc->cod_merc = SPACE(5));
                                   .OR. (mcod_fab > 0 .AND. STRZERO(mcod_fab,4) <> merc->cod_fab);
                                   .OR. (mcod_espe > 0 .AND. STRZERO(mcod_espe,4) <> merc->especie);
                                   .OR. (! EMPTY(mgrupo1) .AND. SUBSTR(merc->gru_sub,1,3) <> SUBSTR(mgrupo1,1,3));
                                   .OR. (! EMPTY(msub1) .AND. merc->gru_sub <> SUBSTR(mgrupo1,1,3)+msub1);
                                   .OR. (! EMPTY(mdata_r) .AND. merc->ul_alt_pr > mdata_r)
                                        SKIP;LOOP
                                ENDIF
                                DEVPOS(PROW()+1,00);DEVOUT(merc->cod_merc+'-'+merc->merc)
                                DEVPOS(PROW(),52);DEVOUT(TRANSFORM(merc->pr_venda,'999,999.99'))
                                IF mvenda = 'X'
                                        merc-> pr_venda := iat(merc->pr_venda * ((mperc/100)+1),maredonda)
                                        merc-> ul_alt_pr := mdata_sis
                                        merc-> opera_pr := cod_operado
                                ENDIF
                                DEVPOS(PROW(),PCOL()+1);DEVOUT(TRANSFORM(merc->pr_venda,'999,999.99'))
                                DEVPOS(PROW(),PCOL()+1);DEVOUT(TRANSFORM(merc->pr_venda1,'999,999.99'))
                                IF mvenda2 = 'X'
                                        merc-> pr_venda1 := iat(merc->pr_venda1 * ((mperc/100)+1),maredonda)
                                ENDIF
                                DEVPOS(PROW(),PCOL()+1);DEVOUT(TRANSFORM(merc->pr_venda1,'999,999.99'))
                                DEVPOS(PROW(),PCOL()+1);DEVOUT(TRANSFORM(merc->cust_real,'999,999.99'))
                                IF mreal = 'X'
                                        merc-> cust_real := iat(merc->cust_real * ((mperc/100)+1),maredonda)
                                ENDIF
                                DEVPOS(PROW(),PCOL()+1);DEVOUT(TRANSFORM(merc->cust_real,'999,999.99'))
                                DEVPOS(PROW(),PCOL()+1);DEVOUT(TRANSFORM(merc->cust_merc,'999,999.99'))
                                IF mcust_merc = 'X'
                                        merc-> cust_merc := iat(merc->cust_merc * ((mperc/100)+1),maredonda)
                                ENDIF
                                DEVPOS(PROW(),PCOL()+1);DEVOUT(TRANSFORM(merc->cust_merc,'999,999.99'))
                                DEVPOS(PROW(),PCOL()+1);DEVOUT(TRANSFORM(merc->pr_fat,'999,999.99'))
                                IF mprc_esp = 'X'
                                        merc-> pr_fat := iat(merc->pr_fat * ((mperc/100)+1),maredonda)
                                ENDIF
                                merc-> data_atu := mdata_sis
                                DEVPOS(PROW(),PCOL()+1);DEVOUT(TRANSFORM(merc->pr_fat,'999,999.99'))
                                SKIP
                        ENDDO
                        DBCOMMITALL()
                        DBUNLOCKALL()
                        SETPRC(00,00)
                        EJECT
                        SET DEVI TO SCREEN;SET PRINT TO;SET PRINT OFF
                        conf_impressao('REAJUSTE.REL')
                ELSE
                        atencao('Nao foi possivel acessar o Arquivo !!!')
                        LOOP
                ENDIF
        ELSE
                mensagem('Espere o Final do Reajuste das Mercadorias !!!')
                IF ! imp_arq('REAJUSTE.REL','R')
                        LOOP
                ENDIF
                ********************
                SELE('merc');ORDSETFOCUS(2)
                GO TOP
                ********************
                SET SOFTSEEK ON
                SEEK mgrupo1
                SET SOFTSEEK OFF
                DEVPOS(PROW()+1,00);DEVOUT(mtraco)
                DEVPOS(PROW()+1,00);DEVOUT('PRODUTO')
                DEVPOS(PROW(),52);DEVOUT('Venda ANT.')
                DEVPOS(PROW(),PCOL()+1);DEVOUT('Venda POS.')
                DEVPOS(PROW(),PCOL()+1);DEVOUT('Venda2 ANT')
                DEVPOS(PROW(),PCOL()+1);DEVOUT('Venda2 POS')
                DEVPOS(PROW(),PCOL()+1);DEVOUT('Cus.REAL A')
                DEVPOS(PROW(),PCOL()+1);DEVOUT('Cus.REAL P')
                DEVPOS(PROW(),PCOL()+1);DEVOUT('Cus.MERC A')
                DEVPOS(PROW(),PCOL()+1);DEVOUT('Cus.MERC P')
                DEVPOS(PROW(),PCOL()+1);DEVOUT('Pr.Esp.ANT')
                DEVPOS(PROW(),PCOL()+1);DEVOUT('Pr.Esp.POS')
                DEVPOS(PROW()+1,00);DEVOUT(mtraco)
                WHILE SUBSTR(merc->gru_sub,1,3) = SUBSTR(mgrupo1,1,3) .AND. ! EOF() .AND. LASTKEY() <> 27
                            prog_imp(RECNO(),merc->cod_merc+'-'+merc->merc)
                            IF (merc->cod_merc = SPACE(5));
                                    .OR. (mcod_fab > 0 .AND. STRZERO(mcod_fab,4) <> merc->cod_fab);
                                    .OR. (mcod_espe > 0 .AND. STRZERO(mcod_espe,4) <> merc->especie);
                                    .OR. (! EMPTY(mgrupo1) .AND. SUBSTR(merc->gru_sub,1,3) <> SUBSTR(mgrupo1,1,3));
                                    .OR. (! EMPTY(msub1) .AND. merc->gru_sub <> SUBSTR(mgrupo1,1,3)+msub1);
                                    .OR. (! EMPTY(mdata_r) .AND. merc->ul_alt_pr > mdata_r)
                                    SKIP;LOOP
                            ENDIF
                            BLOQREG()
                            DEVPOS(PROW()+1,00);DEVOUT(merc->cod_merc+'-'+merc->merc)
                            DEVPOS(PROW(),52);DEVOUT(TRANSFORM(merc->pr_venda,'999,999.99'))
                            IF mvenda = 'X'
                                    merc-> pr_venda := iat(merc->pr_venda * ((mperc/100)+1),maredonda)
                                    merc-> opera_pr := cod_operado
                                    merc-> ul_alt_pr := mdata_sis
                            ENDIF
                            DEVPOS(PROW(),PCOL()+1);DEVOUT(TRANSFORM(merc->pr_venda,'999,999.99'))
                            DEVPOS(PROW(),PCOL()+1);DEVOUT(TRANSFORM(merc->pr_venda1,'999,999.99'))
                            IF mvenda2 = 'X'
                                    merc-> pr_venda1 := iat(merc->pr_venda1 * ((mperc/100)+1),maredonda)
                            ENDIF
                            DEVPOS(PROW(),PCOL()+1);DEVOUT(TRANSFORM(merc->pr_venda1,'999,999.99'))
                            DEVPOS(PROW(),PCOL()+1);DEVOUT(TRANSFORM(merc->cust_real,'999,999.99'))
                            IF mreal = 'X'
                                    merc-> cust_real := iat(merc->cust_real * ((mperc/100)+1),maredonda)
                            ENDIF
                            DEVPOS(PROW(),PCOL()+1);DEVOUT(TRANSFORM(merc->cust_real,'999,999.99'))
                            DEVPOS(PROW(),PCOL()+1);DEVOUT(TRANSFORM(merc->cust_merc,'999,999.99'))
                            IF mcust_merc = 'X'
                                    merc-> cust_merc := iat(merc->cust_merc * ((mperc/100)+1),maredonda)
                            ENDIF
                            DEVPOS(PROW(),PCOL()+1);DEVOUT(TRANSFORM(merc->cust_merc,'999,999.99'))
                            DEVPOS(PROW(),PCOL()+1);DEVOUT(TRANSFORM(merc->pr_fat,'999,999.99'))
                            IF mprc_esp = 'X'
                                    merc-> pr_fat := iat(merc->pr_fat * ((mperc/100)+1),maredonda)
                            ENDIF
                            merc-> data_atu := mdata_sis
                            DEVPOS(PROW(),PCOL()+1);DEVOUT(TRANSFORM(merc->pr_fat,'999,999.99'))
                            DBUNLOCK()
                            SKIP
                ENDDO
                DBCOMMITALL()
                SETPRC(00,00)
                SET DEVI TO SCREEN;SET PRINT TO;SET PRINT OFF
                conf_impressao('REAJUSTE.REL')
        ENDIF
        sr_getconnection():exec('INSERT INTO saclog (data_sis,data,hora,tipo,documento,aut_oper,cod_oper,modulo,descri,cod_aut,terminal'+;
                ',SR_DELETED )'+;
                ' VALUES ('+;
                sr_cdbvalue(DATE()       )+','+; //1
                sr_cdbvalue(mdata_sis    )+','+; //2
                sr_cdbvalue(TIME()       )+','+; //3
                sr_cdbvalue('REAJUSTE   ')+','+; //4
                sr_cdbvalue('PRODUTO    ')+','+; //5
                sr_cdbvalue(cod_operado  )+','+; //7
                sr_cdbvalue(cod_operado  )+','+; //8
                sr_cdbvalue('SAC271'     )+','+;//9
                sr_cdbvalue('REAJUSTE DE PRODUTOS'+IF(! EMPTY(mgrupo1),' ** POR GRUPO **',' ** TOTAL **')+' - Perc.:'+TRANSFORM(mperc,'999.99')+' %')+','+;//10
                sr_cdbvalue(cod_operado  )+','+; //11
                sr_cdbvalue(LEFT(NETNAME(),15))+','+; //12
                sr_cdbvalue(' ')+')',,.f.)

        sr_getconnection():exec("COMMIT",,.f.)

ENDDO
wvw_lclosewindow()
RETURN NIL
***************************** F I M **************************************
FUNCTION sac272
***************
LOCAL MPRG:='SAC272',;
      lba,cba,mcod_cli1,mcod_cli2,mperc,mcod_merc,opcao

IF ! ver_nivel(mprg,'REAJUSTE DE PERCENTUAL DESCONTO CLIENTE/MERCADORIA','15',nivel_acess,,'AMBIE')
        RETURN NIL
ENDIF

lba := 11
cba := 75
*--------------------------------------------------------------------------
IF ! AbriArq('sactabme','tabme');RETURN NIL;ENDIF
IF ! AbriArq('sacmerc','merc');RETURN NIL;ENDIF
IF ! AbriArq('saccli','cli');RETURN NIL;ENDIF
*--------------------------------------------------------------------------
op_tela(0,0,lba,cba,' Reajuste de Percentual Desconto CLIENTE/MERCADORIA ')
WHILE .T.
        exibi_prg(mprg)
        limpa(0,0,lba,cba)
        mcod_cli1 := mcod_cli2 := mcod_merc := mperc := 0
        mensagem('Preencha os Campos - <ESC>p/Abandonar')
        setcor(3)
        setcor(1)
        DEVPOS(1,2);DEVOUT('Cod.Cliente 1o.:')
        DEVPOS(2,2);DEVOUT('Cod.Cliente 2o.:')
        DEVPOS(3,2);DEVOUT('Cod.Mercadoria.:')
        DEVPOS(4,2);DEVOUT('Percentual (%).:')
        @ 1,19 GET mcod_cli1 PICT '99999' VALID IF(EMPTY(mcod_cli1),.F.,.T.) .AND. ver_cli(mcod_cli1,1,26)
        @ 2,19 GET mcod_cli2 PICT '99999' VALID IF(mcod_cli2 < mcod_cli1,.F.,.T.) .AND. ver_cli(mcod_cli2,2,26)
        @ 3,19 GET mcod_merc PICT '99999' VALID ver_cod(mcod_merc,3,26,,0)
        @ 4,19 GET mperc PICT '999.99'
        READ
        IF LASTKEY() = 27
                EXIT
        ENDIF
        ********************
        SELE('tabme');ORDSETFOCUS(2)
        GO TOP
        ********************
        tabme->(DBSEEK(STRZERO(mcod_cli1,5),.T.))
        IF EOF()
                atencao('Nao existe nenhum CLIENTE !!!')
                LOOP
        ENDIF
        IF ! BLOQARQ()
                atencao('Nao foi possivel BLOQUEAR este ARQUIVO')
                LOOP
        ENDIF
        WHILE VAL(tabme->cod_cli) <= mcod_cli2 .AND. ! EOF()
                IF ! EMPTY(mcod_merc) .AND. tabme->codigo <> mcod_merc
                        SKIP
                        LOOP
                ENDIF
                tabme->data     := mdata_sis
                tabme->desconto := mperc
                DBCOMMIT()
                SKIP
        ENDDO
        DBCOMMITALL()
        DBUNLOCKALL()
ENDDO
wvw_lclosewindow()
RETURN NIL
***************************** F I M **************************************
FUNCTION sac273
***************
LOCAL MPRG:='SAC273',;
      lba,cba,mperc,mcod_merc,opcao,mvalor:=0

PRIVATE mtraco

IF ! ver_nivel(mprg,'REAJUSTE DAS MERCADORIA P/DETALHES','15',nivel_acess,,'AMBIE')
        RETURN NIL
ENDIF

lba := 11
cba := 75
*--------------------------------------------------------------------------
IF ! AbriArq('merc_det','deta');RETURN NIL;ENDIF
IF ! AbriArq('sactabme','tabme');RETURN NIL;ENDIF
IF ! AbriArq('sacmerc','merc');RETURN NIL;ENDIF
IF ! AbriArq('saccli','cli');RETURN NIL;ENDIF
*--------------------------------------------------------------------------
op_tela(0,0,lba,cba,' Reajuste das Mercadoria pelo Detalhes ')
WHILE .T.
        exibi_prg(mprg)
        mcod_merc := mvalor := mperc := 0
        mensagem('Preencha os Campos - <ESC>p/Abandonar')
        setcor(3)
        limpa(0,0,lba,cba)
        setcor(1)
        DEVPOS(1,2);DEVOUT('Cod.Mercadoria.:')
        DEVPOS(2,2);DEVOUT('Percentual (%).:')
        DEVPOS(3,2);DEVOUT('Valor R$.......:')
        @ 1,19 GET mcod_merc PICT '99999' VALID ver_cod(mcod_merc,1,26,,0)
        @ 2,19 GET mperc PICT '999.99'
        @ 3,19 GET mvalor PICT '9,999,999.99'
        READ
        IF LASTKEY() = 27
                EXIT
        ENDIF
        ********************
        SELE('deta');ORDSETFOCUS(1)
        GO TOP
        ********************
        IF ! deta->(DBSEEK(mcod_merc))
                atencao('Este Produto nao tem Detalhes')
                LOOP
        ENDIF
        opcao := op_simnao('S','Confirma o Reajuste da Mercadoria:')
        IF opcao = 'N'
                LOOP
        ENDIF
        IF ! BLOQARQ()
                atencao('Nao foi possivel BLOQUEAR este ARQUIVO')
                LOOP
        ENDIF
        WHILE mcod_merc = deta->codigo .AND. ! EOF()
                IF ! EMPTY(deta->dat_venda) .OR. ! EMPTY(deta->vl_vendido) .OR. deta->venda = 'V'
                        SKIP
                        LOOP
                ENDIF
                IF ! EMPTY(mvalor)
                        deta-> vlr_venda := mvalor
                ELSE
                        deta-> vlr_venda := deta->vlr_venda * ((mperc/100)+1)
                ENDIF
                DBCOMMIT()
                SKIP
        ENDDO
        DBCOMMITALL()
        DBUNLOCKALL()
ENDDO
wvw_lclosewindow()
RETURN NIL
***************************** F I M ************************************
* AJUSTAR DO SALDOS DOS PRODUTOS
********************************
FUNCTION sac274
***************
LOCAL MPRG:='SAC274',;
      lba,cba,msub1,mgrupo1,mcod_merc1,opcao,;
      msaldo_f:=SPACE(1),msaldo_m:=SPACE(1),mquantd:=0

PRIVATE mcod_espe,mcod_fab

IF ! ver_nivel(mprg,'AJUSTAR OS SALDO DOS PRODUTOS','1',nivel_acess,,'AMBIE')
        RETURN NIL
ENDIF
lba := 18
cba := 75
*--------------------------------------------------------------------------
IF ! AbriArq('sacgrupo','grup');RETURN NIL;ENDIF
IF ! AbriArq('sacmerc','merc');RETURN NIL;ENDIF
IF ! AbriArq('sacespe','espe');RETURN NIL;ENDIF
IF ! AbriArq('sacforn','forn');RETURN NIL;ENDIF
*--------------------------------------------------------------------------
IF ! aut_sen('Senha p/Liberar o Ajuste dos saldo dos Produtos:','LIB_AJUST')
        RETURN NIL
ENDIF
op_tela(10,0,lba,cba,' Ajuste dos Saldo dos Produtos ')
WHILE .T.
        exibi_prg(mprg)
        limpa(0,0,lba,cba)
        msub1 := SPACE(2)
        mgrupo1 := SPACE(5)
        mcod_merc1 := mcod_fab := mcod_espe := mquantd := 0
        msaldo_f := msaldo_m := SPACE(1)
        mensagem('Preencha os Campos ou em Branco p/todos - <ESC>p/Abandonar')
        setcor(1)
        DEVPOS(1,2 );DEVOUT('Cod.Grupo......:')
        DEVPOS(2,2 );DEVOUT('Cod.Sub-Grupo..:')
        DEVPOS(3,2 );DEVOUT('Cod.Mercadoria.:')
        DEVPOS(4 ,2);DEVOUT('Cod.Especie....:')
        DEVPOS(5 ,2);DEVOUT('Cod.Fabricante.:')
        DEVPOS(6 ,2);DEVOUT('Saldo Fisico...:')
        DEVPOS(7 ,2);DEVOUT('Saldo Fiscal...:')
        DEVPOS(8 ,2);DEVOUT('Quantidade.....:')
        //DEVPOS(10,2);DEVOUT('Registros Processados:')
        ********************
        SELE('merc');ORDSETFOCUS(1)
        GO TOP
        ********************
        @ 1,19 GET mgrupo1 PICT '999' VALID v_gru_cod(mgrupo1,2,1,25)
        @ 2,19 GET msub1 PICT '99' WHEN ! EMPTY(mgrupo1) VALID ver_sgru(VAL(ALLTRIM(mgrupo1)),VAL(msub1),2,23,.F.)  //v_gru_cod(mgrupo1 + msub1 + mcod_merc1,2)
        @ 3,19 GET mcod_merc1 PICT '99999' WHEN mgrupo1 = SPACE(3) VALID ver_cod(mcod_merc1,3,25,,0)
        @ 4,19 GET mcod_espe PICT '9999' VALID ver_espe(mcod_espe,4,24,,0)
        @ 5,19 GET mcod_fab PICT '9999' VALID ver_fab(mcod_fab,5,24)
        @ 6,19 GET msaldo_m PICT '@!' VALID msaldo_m $ 'X, '
        @ 7,19 GET msaldo_f PICT '@!' VALID msaldo_f $ 'X, '
        @ 8,19 GET mquantd PICT '999,999.99'
        READ
        IF LASTKEY() = 27
                RELEASE ALL
                EXIT
        ENDIF
        opcao := op_simnao('N','Confirma o Ajuste dos Saldos:')
        IF LASTKEY() = 27 .OR. opcao = 'N'
                LOOP
        ENDIF
        mensagem('Aguarde o final do processo...')
        SR_BEGINTRANSACTION()
        TRY
                cComm  := "UPDATE sacmerc SET data_atu = "+sr_cdbvalue(mdata_sis)
                //ccomm := ccomm +",chv_cript = "+sr_cdbvalue(criptografia(mlinha,'C'))
                IF msaldo_m = 'X'
                        ccomm := ccomm +",saldo_mer = "+sr_cdbvalue(mquantd)
                ENDIF
                IF msaldo_f = 'X'
                        ccomm := ccomm +",saldo_fis = "+sr_cdbvalue(mquantd)
                ENDIF
                ccomm := ccomm + " WHERE cod_merc IS NOT NULL "
                IF ! EMPTY(mgrupo1) .AND. EMPTY(msub1)
                        ccomm := ccomm + " AND gru_sub LIKE "+sr_cdbvalue(ALLTRIM(mgrupo1)+'%')
                ENDIF
                IF ! EMPTY(msub1)
                        ccomm := ccomm + " AND gru_sub = "+sr_cdbvalue(ALLTRIM(mgrupo1+msub1))
                ENDIF
                IF ! EMPTY(mcod_merc1)
                        ccomm := ccomm + " AND cod_merc = "+sr_cdbvalue(STRZERO(mcod_merc1,5))
                ENDIF

                IF ! EMPTY(mcod_fab)
                        ccomm := ccomm + " AND cod_fab = "+sr_cdbvalue(mcod_fab)
                ENDIF

                IF ! EMPTY(mcod_espe)
                        ccomm := ccomm + " AND cod_espe = "+sr_cdbvalue(mespecie)
                ENDIF
                sr_getconnection():exec(ccomm,,.f.)
        CATCH e
        SR_ENDTRANSACTION()
        END
        IF msaldo_f = 'X'
                cons_merc := {}
                sr_getconnection():exec("SELECT cod_merc FROM sacmerc",,.t.,cons_merc)
                IF LEN(cons_merc) = 0
                        LOOP
                ENDIF
                i:=0
                FOR i = 1 TO LEN(cons_merc)
                        sr_getconnection():exec('INSERT INTO logprod_fis (data_sis,data,'+;
                                'hora,cod_prod,quantd,saldo_ant,saldo_pos,cod_oper,prog,terminal,'+;
                                'processo,ent_sai )'+;
                                ' VALUES ('+;
                                sr_cdbvalue(DATE())+','+; //1
                                sr_cdbvalue(mdata_sis)+','+; //2
                                sr_cdbvalue(TIME())+','+; //3
                                sr_cdbvalue(cons_merc[i,1])+','+; //4
                                sr_cdbvalue(mquantd)+','+; //5
                                sr_cdbvalue(0)+','+; //6
                                sr_cdbvalue(mquantd)+','+; //7
                                sr_cdbvalue(cod_operado)+','+; //8
                                sr_cdbvalue('SAC274')+','+; //9
                                sr_cdbvalue(LEFT(NETNAME(),15))+','+; //12
                                sr_cdbvalue('AJUSTAR OS SALDO DOS PRODUTOS')+','+; //11
                                sr_cdbvalue('A')+')',,.f.)
                NEXT
                sr_getconnection():exec("COMMIT",,.f.)
        ENDIF
        //ATENCAO(ccomm)
        sr_getconnection():exec('COMMIT',,.f.)
ENDDO
wvw_lclosewindow()
RETURN NIL
***************************** F I M **************************************
* AJUSTAR O LOCAL DOS PRODUTOS PELO FORNECEDOR
******************************************
FUNCTION sac275
***************
LOCAL MPRG:='SAC275',lba,cba

PRIVATE mcod_espe,mcod_fab

IF ! ver_nivel(mprg,'AJUSTAR O LOCAL DOS PRODUTOS PELO FORNECEDOR','1',nivel_acess,,'AMBIE')
        RETURN NIL
ENDIF

lba := 07
cba := 75
*--------------------------------------------------------------------------
IF ! AbriArq('sacforn','forn');RETURN NIL;ENDIF
*--------------------------------------------------------------------------
op_tela(5,10,lba,cba,'AJUSTAR O LOCAL DOS PRODUTOS PELO FORNECEDOR')
WHILE .T.
        exibi_prg(mprg)
        limpa(5,10,lba,cba)
        mcod_fab :=  0
        mensagem('Preencha os Campos ou em Brnaco p/todos - <ESC>p/Abandonar')
        DEVPOS(01,01);DEVOUT('Cod.Fabricante.:')
        @ 01,19 GET mcod_fab PICT '9999' VALID ver_fab(mcod_fab,01,24)
        READ
        IF LASTKEY() = 27
                RELEASE ALL
                EXIT
        ENDIF
        opcao := op_simnao('N','Confirma a Atualizacao dos Produtos:')
        IF LASTKEY() = 27 .OR. opcao = 'N'
                LOOP
        ENDIF

        cons_forn := {}
        cComm  := "SELECT * FROM sacforn WHERE tipo = '1.01'"
        sr_getconnection():exec(ccomm,,.t.,cons_forn)
        IF LEN(cons_forn) = 0
                LOOP
        ENDIF
        FOR i = 1 TO LEN(cons_forn)
                prog_imp(i,cons_forn[i,1]+' - '+cons_forn[i,2])
                cons_doc := {}
                sr_getconnection():exec("UPDATE sacmerc SET local = "+sr_cdbvalue(SUBSTR(cons_forn[i,11],1,4))+" WHERE cod_fab = "+sr_cdbvalue(cons_forn[i,1]),,.f.)
        NEXT
        sr_getconnection():exec('COMMIT',,.f.)
        atencao('Atualizacao foi feita com sucesso....')
        EXIT
ENDDO
wvw_lclosewindow()
RETURN NIL
***************************** F I M **************************************
* AJUSTAR DE GRUPO E SUB-GRUPO DOS PRODUTOS NO MOVIMENTO E PEDIDOS
******************************************
FUNCTION sac276
***************
LOCAL MPRG:='SAC276',;
      msub := SPACE(2),mgrupo := SPACE(5)

IF ! ver_nivel(mprg,'AJUSTAR DE GRUPO E SUB-GRUPO DOS PRODUTOS NO MOVIMENTO E PEDIDOS','1',nivel_acess,,'AMBIE')
        RETURN NIL
ENDIF
op_tela(10,10,12,70,'AJUSTAR DE GRUPO E SUB-GRUPO DOS PRODUTOS NO MOVIMENTO E PEDIDOS')
WHILE .T.
        exibi_prg(mprg)
        limpa(00,00,30,100)
        msub := SPACE(2)
        mgrupo := SPACE(5)
        mensagem('Preencha os Campos ou em Brnaco p/todos - <ESC>p/Abandonar')
        DEVPOS(01,01);DEVOUT('Codigo Grupo....:')
        DEVPOS(02,01);DEVOUT('Codigo Sub-Grupo:')
        @ 01,20 GET mgrupo PICT '999' VALID v_gru_cod(mgrupo,2,01,24)
        @ 02,20 GET msub PICT '99' WHEN ! EMPTY(mgrupo) VALID ver_sgru(VAL(ALLTRIM(mgrupo)),VAL(msub),02,24,.F.)  //v_gru_cod(mgrupo1 + msub1 + mcod_merc1,2)
        READ
        IF LASTKEY() = 27
                RELEASE ALL
                EXIT
        ENDIF
        opcao := op_simnao('N','Confirma a Atualizacao dos Produtos:')
        IF LASTKEY() = 27 .OR. opcao = 'N'
                LOOP
        ENDIF

        cons_merc := {}
        cComm  := "SELECT * FROM sacmerc WHERE gru_sub IS NOT NULL"
        IF ! EMPTY(mgrupo)
                ccomm := ccomm + " AND gru_sub LIKE "+sr_cdbvalue(STRZERO(VAL(mgrupo),3)+'%')
        ENDIF
        IF ! EMPTY(msub)
                ccomm := ccomm + " AND gru_sub LIKE "+sr_cdbvalue(ALLTRIM(mgrupo)+ALLTRIM(msub))
        ENDIF
        ccomm := ccomm + " ORDER BY merc"
        sr_getconnection():exec(ccomm,,.t.,cons_merc)
        IF LEN(cons_merc) = 0
                LOOP
        ENDIF
        i:=0
        FOR i = 1 TO LEN(cons_merc)
                prog_imp(i,cons_merc[i,8]+' - '+cons_merc[i,9])
                cComm  := "UPDATE sacmov SET gru_sub = "+sr_cdbvalue(cons_merc[i,7])+" WHERE codigo = "+sr_cdbvalue(cons_merc[i,8])
                sr_getconnection():exec(ccomm,,.f.)
                cComm  := "UPDATE sacped_s SET pgru_sub = "+sr_cdbvalue(cons_merc[i,7])+" WHERE pcod_merc = "+sr_cdbvalue(cons_merc[i,8])
                sr_getconnection():exec(ccomm,,.f.)
        NEXT
        sr_getconnection():exec('COMMIT',,.f.)
        atencao('Atualizacao foi feita com sucesso....')
        EXIT
ENDDO
wvw_lclosewindow()
RETURN NIL
***************************** F I M **************************************
* EXCLUIR PRODUTOS APARTIR DE DETERMINADA DATA DE SAIDA
*******************************************************
FUNCTION sac277
***************
LOCAL MPRG:='SAC277',;
      mdata := CTOD('  /  /  '),opcao,msub := SPACE(2),mgrupo := SPACE(5),cons_merc:={},cons_excl:={},cons_mov:={},point:=0,;
      mcom_saldo:='N'

IF ! ver_nivel(mprg,'EXCLUIR PRODUTOS APARTIR DE DETERMINADA DATA DE SAIDA','1',nivel_acess,,'AMBIE')
        RETURN NIL
ENDIF
op_tela(02,10,32,90,'EXCLUIR PRODUTOS APARTIR DE DETERMINADA DATA DE SAIDA')
WHILE .T.
        exibi_prg(mprg)
        limpa(00,00,30,100)
        msub := SPACE(2)
        mgrupo := SPACE(5)
        mdata  := CTOD('  /  /  ')
        mcom_saldo := 'N'
        mensagem('Preencha os Campos ou em Brnaco p/todos - <ESC>p/Abandonar')
        DEVPOS(0,01);DEVOUT('EXCLUIR PRODUTOS APARTIR DA DATA ULTIMA SAIDA:')
        DEVPOS(01,01);DEVOUT('Codigo Grupo................................:')
        DEVPOS(02,01);DEVOUT('Codigo Sub-Grupo............................:')
        DEVPOS(03,01);DEVOUT('Deseja Incluir os Produto com SALDO.........:')
        @ 04,00 TO 04,100
        @ 06,00 TO 06,100
        @ 28,00 TO 28,100
        setcor(3)
        DEVPOS(05,01);DEVOUT('PRODUTO')
        DEVPOS(05,56);DEVOUT('SALDO')
        DEVPOS(29,01);DEVOUT('Quantidade de Produtos:')
        setcor(1)
        @ 0,48 GET mdata VALID IF(EMPTY(mdata),.F.,.T.)
        @ 1,48 GET mgrupo PICT '999' VALID v_gru_cod(mgrupo,2,01,24)
        @ 2,48 GET msub PICT '99' WHEN ! EMPTY(mgrupo) VALID ver_sgru(VAL(ALLTRIM(mgrupo)),VAL(msub),02,24,.F.)  //v_gru_cod(mgrupo1 + msub1 + mcod_merc1,2)
        @ 3,48 GET mcom_saldo PICT '@!' VALID mcom_saldo $ 'S,N'
        READ
        IF LASTKEY() = 27
                RELEASE ALL
                EXIT
        ENDIF
        opcao := op_simnao('S','Confirma a CONSULTA dos Produtos:')
        IF LASTKEY() = 27 .OR. opcao = 'N'
                LOOP
        ENDIF
        cons_merc := {}
        cComm  := "SELECT * FROM sacmerc WHERE gru_sub IS NOT NULL"
        IF ! EMPTY(mgrupo)
                ccomm := ccomm + " AND gru_sub LIKE "+sr_cdbvalue(STRZERO(VAL(mgrupo),3)+'%')
        ENDIF
        IF ! EMPTY(msub)
                ccomm := ccomm + " AND gru_sub LIKE "+sr_cdbvalue(ALLTRIM(mgrupo)+ALLTRIM(msub))
        ENDIF
        IF mcom_saldo = 'N'
                ccomm := ccomm + " AND (saldo_mer <= "+sr_cdbvalue(0)+" OR saldo_mer IS NULL)"
        ENDIF
        ccomm := ccomm + " ORDER BY merc"
        sr_getconnection():exec(ccomm,,.t.,cons_merc)
        IF LEN(cons_merc) = 0
                LOOP
        ENDIF
        cons_excl:={}
        i:=0
        FOR i = 1 TO LEN(cons_merc)
                prog_imp(i,cons_merc[i,8]+' - '+cons_merc[i,9])
                cons_mov := {}
                cComm  := "SELECT * FROM sacped_s WHERE sr_deleted = ' ' AND pcod_merc = "+sr_cdbvalue(cons_merc[i,8])+" AND pdatapag >= "+sr_cdbvalue(mdata)
                sr_getconnection():exec(ccomm,,.t.,cons_mov)
                IF LEN(cons_mov) > 0
                        LOOP
                ENDIF
                AADD(cons_excl,cons_merc[i,8]+' - '+cons_merc[i,9]+'  '+TRANSFORM(cons_merc[i,56],'999,999.99'))
        NEXT
        DEVPOS(29,25);DEVOUT(TRANSFORM(LEN(cons_excl),'999,999'))
        CLEAR TYPEAHEAD
        mensagem("<ESC> Retorna  -  <ENTER> p/Resumo" )
        point := ACHOICE(07,01,27,84,cons_excl,,,point)
        opcao := op_simnao('N','Confirma a EXCLUSAO dos Produtos:')
        IF LASTKEY() = 27 .OR. opcao = 'N'
                LOOP
        ENDIF
        i:=0
        FOR i = 1 TO LEN(cons_excl)
                cComm  := "DELETE FROM sacmerc WHERE cod_merc = "+sr_cdbvalue(SUBSTR(cons_excl[i],1,5))
                sr_getconnection():exec(ccomm,,.f.)
        NEXT
ENDDO
wvw_lclosewindow()
RETURN NIL
***************************** F I M **************************************
* ALTERAR PRODUTOS PARA ISENTO SIM OU NAO POR GREUPO E SUB-GRUPO
*******************************************************
FUNCTION sac278
***************
LOCAL MPRG:='SAC278',;
      msub := SPACE(2),mgrupo := SPACE(5),misento:='N'

IF ! ver_nivel(mprg,'ALTERAR PRODUTOS PARA ISENTO SIM OU NAO POR GREUPO E SUB-GRUPO','1',nivel_acess,,'AMBIE')
        RETURN NIL
ENDIF

IF ! AbriArq('sacgrupo','grup');RETURN NIL;ENDIF

op_tela(12,10,14,90,'ALTERAR PRODUTOS PARA ISENTO OU NAO POR GREUPO E SUB-GRUPO')
WHILE .T.
        exibi_prg(mprg)
        limpa(00,00,30,100)
        msub := SPACE(2)
        mgrupo := SPACE(5)
        mensagem('Preencha os Campos ou em Brnaco p/todos - <ESC>p/Abandonar')
        DEVPOS(00,01);DEVOUT('Codigo Grupo..........:')
        DEVPOS(01,01);DEVOUT('Codigo Sub-Grupo......:')
        DEVPOS(02,01);DEVOUT('Isento [S]im ou [N]ao.:')
        setcor(1)
        @ 0,26 GET mgrupo PICT '999' VALID v_gru_cod(mgrupo,2,0,30)
        @ 1,26 GET msub PICT '99' WHEN ! EMPTY(mgrupo) VALID ver_sgru(VAL(ALLTRIM(mgrupo)),VAL(msub),01,30,.F.)  //v_gru_cod(mgrupo1 + msub1 + mcod_merc1,2)
        @ 2,26 GET misento PICT '@!' VALID misento $ 'S,N'
        READ
        IF LASTKEY() = 27
                RELEASE ALL
                EXIT
        ENDIF
        IF 'N' = op_simnao('S','Confirma a OPERACAO dos Produtos:')
                LOOP
        ENDIF
        sr_getconnection():exec("UPDATE sacmerc SET isento = "+sr_cdbvalue(misento)+" WHERE gru_sub = "+sr_cdbvalue(SUBSTR(mgrupo,1,3)+msub),,.f.)
        sr_getconnection():exec("COMMIT",,.f.)
ENDDO
wvw_lclosewindow()
RETURN NIL
***************************** F I M **************************************
* ALTERAR MARGEM DE LUCRO PRODUTOS
***********************************
FUNCTION sac279
***************
LOCAL MPRG:='SAC279',;
      msub := SPACE(2),mgrupo := SPACE(5),mperc:=0

IF ! ver_nivel(mprg,'ALTERAR MARGEM DE LUCRO PRODUTOS','1',nivel_acess,,'AMBIE')
        RETURN NIL
ENDIF

IF ! AbriArq('sacgrupo','grup');RETURN NIL;ENDIF

op_tela(12,10,14,90,'ALTERAR MARGEM DE LUCRO PRODUTOS')
WHILE .T.
        exibi_prg(mprg)
        limpa(00,00,30,100)
        msub := SPACE(2)
        mgrupo := SPACE(5)
        mperc:=0
        mensagem('Preencha os Campos ou em Brnaco p/todos - <ESC>p/Abandonar')
        DEVPOS(00,01);DEVOUT('Codigo Grupo..........:')
        DEVPOS(01,01);DEVOUT('Codigo Sub-Grupo......:')
        DEVPOS(02,01);DEVOUT('Percentual de Lucro(%):')
        setcor(1)
        @ 0,26 GET mgrupo PICT '999' VALID v_gru_cod(mgrupo,2,0,30)
        @ 1,26 GET msub PICT '99' WHEN ! EMPTY(mgrupo) VALID ver_sgru(VAL(ALLTRIM(mgrupo)),VAL(msub),01,30,.F.)  //v_gru_cod(mgrupo1 + msub1 + mcod_merc1,2)
        @ 2,26 GET mperc PICT '9,999.99'
        READ
        IF LASTKEY() = 27
                RELEASE ALL
                EXIT
        ENDIF
        IF 'N' = op_simnao('S','Confirma a OPERACAO dos Produtos:')
                LOOP
        ENDIF
        ccomm := "UPDATE sacmerc SET p_lucro = "+sr_cdbvalue(mperc)
        IF ! EMPTY(mgrupo)
                ccomm := ccomm + +" WHERE gru_sub = "+sr_cdbvalue(SUBSTR(mgrupo,1,3)+msub)
        ENDIF
        sr_getconnection():exec(ccomm,,.f.)
        sr_getconnection():exec("COMMIT",,.f.)
ENDDO
wvw_lclosewindow()
RETURN NIL
***************************** F I M **************************************
* VERIFICAR PRODUTOS COM CODIGOS IGUAIS
***************************************
FUNCTION sac280
***************
LOCAL MPRG:='SAC280',;
      opcao,cons_merc:={},cons_excl:={},cons_mov:={},point:=0,i:=0,f:=0,m_cod:={},marq:=SPACE(50)

IF ! ver_nivel(mprg,'VERIFICAR PRODUTOS COM CODIGOS IGUAIS','1',nivel_acess,,'AMBIE')
        RETURN NIL
ENDIF
op_tela(12,10,24,90,'VERIFICAR PRODUTOS COM CODIGOS IGUAIS')
WHILE .T.
        exibi_prg(mprg)
        limpa(00,00,30,100)
        msub := SPACE(2)
        mgrupo := SPACE(5)
        mdata  := CTOD('  /  /  ')
        mcom_saldo := 'N'
        mensagem('Preencha os Campos ou em Brnaco p/todos - <ESC>p/Abandonar')
        DEVPOS(2 ,01);DEVOUT('PRODUTOS VERIFICADOS:')
        @ 01,00 TO 01,100
        @ 00,01 SAY 'Nome da TABELA:' GET marq PICT '@!'
        READ
        IF LASTKEY() = 27
                wvw_lclosewindow()
                RETURN NIL
        ENDIF
        IF ! SR_EXISTTABLE(ALLTRIM(marq))
                atencao('Nao foi possivel encontrar esta TABELA...')
                LOOP
        ENDIF
        opcao := op_simnao('S','Confirma a CONSULTA dos Produtos:')
        IF LASTKEY() = 27 .OR. opcao = 'N'
                wvw_lclosewindow()
                RETURN NIL
        ENDIF
        cons_merc := {}
        sr_getconnection():exec("SELECT * FROM "+ALLTRIM(marq)+" ORDER BY cod_merc",,.t.,cons_merc)
        IF LEN(cons_merc) = 0
                LOOP
        ENDIF
        m_cod:={}
        cons_excl:={}
        i:=0
        FOR i = 1 TO LEN(cons_merc)
                cons_mov := {}
                IF ALLTRIM(marq) = 'sacmerc'
                        prog_imp(i,cons_merc[i,8]+' - '+cons_merc[i,9])
                        DEVPOS(2,23);DEVOUT(cons_merc[i,8]+' - '+cons_merc[i,9])
                        sr_getconnection():exec("SELECT * FROM "+ALLTRIM(marq)+" WHERE cod_merc = "+sr_cdbvalue(cons_merc[i,8]),,.t.,cons_mov)
                        IF LEN(cons_mov) > 1
                                mponto := ASCAN(m_cod,cons_merc[i,8])
                                IF mponto = 0
                                        AADD(m_cod,cons_merc[i,8])
                                        f := 0
                                        FOR f = 1 TO LEN(cons_mov)
                                                AADD(cons_excl,cons_mov[f,8]+' - '+cons_mov[f,9]+'  ')
                                        NEXT
                                ENDIF
                        ENDIF
                ELSE
                        prog_imp(i,cons_merc[i,1]+' - '+cons_merc[i,2])
                        DEVPOS(2,23);DEVOUT(cons_merc[i,1]+' - '+cons_merc[i,2])
                        sr_getconnection():exec("SELECT * FROM "+ALLTRIM(marq)+" WHERE cod_merc = "+sr_cdbvalue(cons_merc[i,1]),,.t.,cons_mov)
                        IF LEN(cons_mov) > 1
                                mponto := ASCAN(m_cod,cons_merc[i,1])
                                IF mponto = 0
                                        AADD(m_cod,cons_merc[i,1])
                                        f := 0
                                        FOR f = 1 TO LEN(cons_mov)
                                                AADD(cons_excl,cons_mov[f,1]+' - '+cons_mov[f,2]+'  ')
                                        NEXT
                                ENDIF
                        ENDIF
                ENDIF
        NEXT
        CLEAR TYPEAHEAD
        mensagem("<ESC> Retorna" )
        point := ACHOICE(02,01,23,84,cons_excl,,,point)
        EXIT
ENDDO
wvw_lclosewindow()
RETURN NIL
***************************** F I M **************************************
* AJUSTAR DA ALIQUOTAS DO ICMS PRODUTOS
***************************************
FUNCTION sac281
***************
LOCAL MPRG:='SAC27(sac281)',;
      lba,cba,msub1,mgrupo1,mcod_merc1,opcao,;
      micm_atual:=0,micm_prox:=0

PRIVATE mcod_espe,mcod_fab

IF ! ver_nivel(mprg,'AJUSTAR AS ALIQUOTAS ICMS DOS PRODUTOS','1',nivel_acess,,'AMBIE')
        RETURN NIL
ENDIF
lba := 18
cba := 75
*--------------------------------------------------------------------------
IF ! AbriArq('sacgrupo','grup');RETURN NIL;ENDIF
IF ! AbriArq('sacmerc','merc');RETURN NIL;ENDIF
IF ! AbriArq('sacespe','espe');RETURN NIL;ENDIF
IF ! AbriArq('sacforn','forn');RETURN NIL;ENDIF
*--------------------------------------------------------------------------
IF ! aut_sen('Senha p/Liberar o Ajuste das aliquotas ICMS Produtos:','LIB_AJUST')
        RETURN NIL
ENDIF
op_tela(10,0,lba,cba,' AJUSTAR AS ALIQUOTAS ICMS DOS PRODUTOS ')
WHILE .T.
        exibi_prg(mprg)
        limpa(0,0,lba,cba)
        msub1 := SPACE(2)
        mgrupo1 := SPACE(5)
        mcod_merc1 := mcod_fab := mcod_espe := micm_atual := micm_prox := 0
        mensagem('Preencha os Campos ou em Branco p/todos - <ESC>p/Abandonar')
        setcor(1)
        DEVPOS(1,2 );DEVOUT('Cod.Grupo...........:')
        DEVPOS(2,2 );DEVOUT('Cod.Sub-Grupo.......:')
        DEVPOS(3,2 );DEVOUT('Cod.Mercadoria......:')
        DEVPOS(4 ,2);DEVOUT('Cod.Especie.........:')
        DEVPOS(5 ,2);DEVOUT('Cod.Fabricante......:')
        DEVPOS(6 ,2);DEVOUT('Aliquota ATUAL (%)..:')
        DEVPOS(7 ,2);DEVOUT('Proxima Aliquota (%):')
        //DEVPOS(10,2);DEVOUT('Registros Processados:')
        ********************
        SELE('merc');ORDSETFOCUS(1)
        GO TOP
        ********************
        @ 1,25 GET mgrupo1 PICT '999' VALID v_gru_cod(mgrupo1,2,1,31)
        @ 2,25 GET msub1 PICT '99' WHEN ! EMPTY(mgrupo1) VALID ver_sgru(VAL(ALLTRIM(mgrupo1)),VAL(msub1),2,31,.F.)  //v_gru_cod(mgrupo1 + msub1 + mcod_merc1,2)
        @ 3,25 GET mcod_merc1 PICT '99999' WHEN mgrupo1 = SPACE(3) VALID ver_cod(mcod_merc1,3,31,,0)
        @ 4,25 GET mcod_espe PICT '9999' VALID ver_espe(mcod_espe,4,30,,0) WHEN EMPTY(mcod_merc1)
        @ 5,25 GET mcod_fab PICT '9999' VALID ver_fab(mcod_fab,5,30) WHEN EMPTY(mcod_merc1)
        @ 6,25 GET micm_atual PICT '99.99'
        @ 7,25 GET micm_prox PICT '99.99'
        READ
        IF LASTKEY() = 27
                RELEASE ALL
                EXIT
        ENDIF
        opcao := op_simnao('N','Confirma o Ajuste dos Saldos:')
        IF LASTKEY() = 27 .OR. opcao = 'N'
                LOOP
        ENDIF
        mensagem('Aguarde o final do processo...')
        //SR_BEGINTRANSACTION()
        //TRY
                cComm  := "UPDATE sacmerc SET data_atu = "+sr_cdbvalue(mdata_sis)
                ccomm := ccomm +",bebida = "+sr_cdbvalue(micm_prox)
                IF micm_atual = 17
                        ccomm := ccomm + " WHERE (bebida = 0 or BEBIDA IS NULL or bebida = 17) AND isento = 'T'"
                ELSE
                        ccomm := ccomm + " WHERE bebida = "+sr_cdbvalue(micm_atual)+" AND isento = 'T'"
                ENDIF
                IF ! EMPTY(mgrupo1) .AND. EMPTY(msub1)
                        ccomm := ccomm + " AND gru_sub LIKE "+sr_cdbvalue(ALLTRIM(mgrupo1)+'%')
                ENDIF
                IF ! EMPTY(msub1)
                        ccomm := ccomm + " AND gru_sub = "+sr_cdbvalue(ALLTRIM(mgrupo1+msub1))
                ENDIF
                IF ! EMPTY(mcod_merc1)
                        ccomm := ccomm + " AND cod_merc = "+sr_cdbvalue(STRZERO(mcod_merc1,5))
                ENDIF

                IF ! EMPTY(mcod_fab)
                        ccomm := ccomm + " AND cod_fab = "+sr_cdbvalue(mcod_fab)
                ENDIF

                IF ! EMPTY(mcod_espe)
                        ccomm := ccomm + " AND cod_espe = "+sr_cdbvalue(mespecie)
                ENDIF
                sr_getconnection():exec(ccomm,,.f.)
        //CATCH e
        //SR_ENDTRANSACTION()
        //END
        //ATENCAO(ccomm)
        sr_getconnection():exec('COMMIT',,.f.)
ENDDO
wvw_lclosewindow()
RETURN NIL
***************************** F I M **************************************
