********************************
* TRANSFORMAR ORCAMENTO P/PEDIDO
********************************
MEMVAR mdata_sis,cod_operado,nivel_acess,getlist

FUNCTION sactporc(mno)
***************
/*
LOCAL MPRG:='SACTPORC',mtitulo:='TRANSFORMAR ORCAMENTO EM PEDIDO',;
      mtit,mtipo,;
      mp_venda,msele,morde,mcont,f,mvar,mtelap,mtot_ipi,mperc,mtelaobs,;
      mdocum,mlib:='*',mposicao:=0,aret:={}

PRIVATE m_matriz:={},m_codigo:={},m_merc:={},m_cbarra:={},m_alt:={},i,opcao:=' ',;
        mcod_merc,mquantd:=1,mdesconto,mvlr_fat,mtot_ped,mmerc,mpr_venda,;
        li,ci,lb,cb,mnome_ven,lci,cci,lba,cba,tela,mautoriz,mlibera,;
        mcod_bc,mcont_item,orcamento,sovenda,tela_ant,f4,;
        mprz,mnum_orc:=0,menvelope,mcod_cli,mnome_cli,mponto,mflag,ali,no,mcod_vend,;
        msubtotal,mtot_custo:=0,mcod_aux,mproducao,mcomissao:=0,mcust_real,mvendido:=0,;
        mtipo_fat:= ' ',mnum_ped:=0,mlib_spc:=' ',m_dia[15],m_vlr[15],;
        mqtd_dias:=0,mqtd_prz:=0,mcond_veze:=SPACE(3),mtip_term,;
        mtot_limite:=0,mlim_venc:=0,mlim_avenc:=0,;
        mtipo_imp,mimp_tipo:=0,marq:=SPACE(35),mcom_oper:=0,mtp_venda:='  ',mcodemp:='   ',;
        mobs1,mobs2,mobs3,mobs4,;
        mplaca,mcarro,mmodelo,mkm,mhoras,mtele_mark:=' ',mnum_os:=0,mcod_cond:=0,;
        ali:='orcam',cons_orcam:={},cons_merc:={},mcons_tabpg:=' ',mcod_pres:=0,mcpf,minsc,;
        mdata_pedido
*/
IF (ver_serie() <> '141235' .AND. ver_serie() <> '141387')
        atencao('ESTE MODULO ESTAR EM MANUTENCAO DESCULPE PELO TRANSTORNO LOGO ESTARA LIBERADO...')
        RETURN NIL
ENDIF
/*
i:=0
FOR i=1 TO 15
        m_dia[i]:= m_vlr[i]:=0
NEXT
i:=0
IF ! ver_nivel(mprg,mtitulo,'1245',nivel_acess,,'AMBIE')
        RELEASE ALL
        RETURN NIL
ENDIF
SET KEY -9 TO fecha_tp('1')             // neste mesmo PRG. <F10>Tecla
//SET KEY -9 TO fecha_pd('1')             // neste mesmo PRG. <F10>Tecla
*---------------------------------------------
CLEAR GETS
IF ! AbriArq('insopera','sen');RETURN NIL;ENDIF
mtip_term := m_cfg[2]
IF ! AbriArq('merc_det','deta');RETURN NIL;ENDIF
IF ! AbriArq('sacmerc','merc');RETURN NIL;ENDIF
IF ! AbriArq('sacorcam','orcam');RETURN NIL;ENDIF
IF ! AbriArq('sacnoorc','noorc');RETURN NIL;ENDIF
IF ! AbriArq('sacped_s','ped_s');RETURN NIL;ENDIF
IF ! AbriArq('sacnoped','noped');RETURN NIL;ENDIF
IF ! AbriArq('saccli','cli');RETURN NIL;ENDIF
IF ! AbriArq('sactabme','tabme');RETURN NIL;ENDIF
IF ! AbriArq('sacdolar','dolar');RETURN NIL;ENDIF
*---------------------------------------------
tela = SAVESCREEN(00,00,24,79)

// ABERTURA DA TELA DE PEDIDO

lci := cci := 00
lba = MAXROW()-5
*lba = 17
cba = 90


WHILE .T.
op_tela(00,00,30,90,mtitulo)
ali:='orcam'
mplaca:=mcarro:=mmodelo:= SPACE(15)
mkm := SPACE(12)                                                                                                                                                                                                                                                                                                                                                                                
mobs1:=mobs2:=mobs3:=mobs4:=SPACE(39)                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                 
mproducao := ' '                                                                                                                                                                                                                                                                                                                                                                                
orcamento = 1                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                
tela_ant := SAVESCREEN(00,00,24,79)                                                                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                                                
// FIM DA TELA DE PEDIDO                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                
sovenda = 1                                                                                                                                                                                                                                                                                                                                                                                     
msubtotal := 0                                                                                                                                                                                                                                                                                                                                                                                  
mnome_ven := SPACE(30)                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                
IF ver_serie() = '141287'                                                                                                                                                                                                                                                                                                                                                                       
        mproducao := 'P'                                                                                                                                                                                                                                                                                                                                                                        
        mvar := SAVESCREEN(00,00,24,79)                                                                                                                                                                                                                                                                                                                                                         
        botao(15,24,17,56,,' Tipo de Faturamento ')                                                                                                                                                                                                                                                                                                                                             
        DEVPOS(16,25);DEVOUT('[P]roducao [N]ao producao: ')                                                                                                                                                                                                                                                                                                                                     
        @ 16,52 GET mproducao PICT '@!' VALID mproducao $ 'P,N'                                                                                                                                                                                                                                                                                                                                 
        READ                                                                                                                                                                                                                                                                                                                                                                                    
        RESTSCREEN(00,00,24,79,mvar)                                                                                                                                                                                                                                                                                                                                                            
        DEVPOS(lba,cci);DEVOUT(PADL(IF(mproducao = 'P','PRODUCAO','NAO PRODUCAO'),80))                                                                                                                                                                                                                                                                                                          
ENDIF                                                                                                                                                                                                                                                                                                                                                                                           
SET KEY 287 TO                                                                                                                                                                                                                                                                                                                                                                                  
mautoriz := SPACE(3)                                                                                                                                                                                                                                                                                                                                                                            
IF mno = NIL                                                                                                                                                                                                                                                                                                                                                                                    
        mnum_orc := 0                                                                                                                                                                                                                                                                                                                                                                           
ELSE                                                                                                                                                                                                                                                                                                                                                                                            
        mnum_orc := mno                                                                                                                                                                                                                                                                                                                                                                         
ENDIF                                                                                                                                                                                                                                                                                                                                                                                           
minsc := mcgc := SPACE(14)
mcpf = SPACE(11)
mflag := mtot_custo := mcod_cond:= msubtotal := mtot_ipi  := 0
mcod_vend := SPACE(3)                                                                                                                                                                                                                                                                                                                                                                           
WHILE .T.                                                                                                                                                                                                                                                                                                                                                                                       
        setcor(1)                                                                                                                                                                                                                                                                                                                                                                               
	limpa(00,00,30,90)
	DEVPOS(lci,cci+2);DEVOUT(' No.do Orcamento: ')                                                                                                                                                                                                                                                                                                                                                  
	@ lci+2,cci+1 TO lci+2,cba-1                                                                                                                                                                                                                                                                                                                                                            
	DEVPOS(lci+1,cci+1);DEVOUT('Cod.')                                                                                                                                                                                                                                                                                                                                                      
	DEVPOS(lci+1,cci+7);DEVOUT('Descricao')                                                                                                                                                                                                                                                                                                                                                 
	DEVPOS(lci+1,cci+51);DEVOUT('Qtd.')                                                                                                                                                                                                                                                                                                                                                     
	DEVPOS(lci+1,cci+58);DEVOUT('Vlr.Unit.')                                                                                                                                                                                                                                                                                                                                                
	DEVPOS(lci+1,cci+70);DEVOUT('Vlr.Total')                                                                                                                                                                                                                                                                                                                                                
	setcor(3)                                                                                                                                                                                                                                                                                                                                                                               
	@ lba-4,cci+1 TO lba-4,cba-1                                                                                                                                                                                                                                                                                                                                                            
	@ lba-2,cci+1 TO lba-2,cba-1                                                                                                                                                                                                                                                                                                                                                            
	setcor(1)                                                                                                                                                                                                                                                                                                                                                                               
	DEVPOS(lba-4,cci+1);DEVOUT('Cod.')                                                                                                                                                                                                                                                                                                                                                      
	DEVPOS(lba-4,cci+7);DEVOUT('Descricao')                                                                                                                                                                                                                                                                                                                                                 
	DEVPOS(lba-4,cci+53);DEVOUT('Qtd.')                                                                                                                                                                                                                                                                                                                                                     
	DEVPOS(lba-4,cci+58);DEVOUT('Vlr.Unit.')                                                                                                                                                                                                                                                                                                                                                
	DEVPOS(lba-4,cci+70);DEVOUT('Vlr.Total')                                                                                                                                                                                                                                                                                                                                                
	DEVPOS(lba-1,cci+1);DEVOUT('Item:')                                                                                                                                                                                                                                                                                                                                                     
	IF ver_serie() = '141235' .OR. ver_serie() = '141258' .OR. ver_serie() = '141274'                                                                                                                                                                                                                                                                                                       
	        DEVPOS(lba-1,cci+34);DEVOUT('Sub-IPI:')                                                                                                                                                                                                                                                                                                                                         
	ENDIF                                                                                                                                                                                                                                                                                                                                                                                   
	DEVPOS(lba-1,cci+58);DEVOUT('Total:')	                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                
	mlib := ' '                                                                                                                                                                                                                                                                                                                                                                             
        ASIZE(m_merc,0)                                                                                                                                                                                                                                                                                                                                                                         
        ASIZE(m_matriz,0)                                                                                                                                                                                                                                                                                                                                                                       
        ASIZE(m_codigo,0)                                                                                                                                                                                                                                                                                                                                                                       
        ********* VARIAVEIS DE IMPRESSAO *******************                                                                                                                                                                                                                                                                                                                                    
        mtipo_imp := m_indiv[1,18]                                                                                                                                                                                                                                                                                                                                                                  
        ****************************************************                                                                                                                                                                                                                                                                                                                                    
        mcond_veze:=SPACE(3)                                                                                                                                                                                                                                                                                                                                                                    
        @ lci,cci+20 GET mnum_orc PICT '999999' VALID IF(EMPTY(mnum_orc),.F.,.T.)                                                                                                                                                                                                                                                                                                               
        READ                                                                                                                                                                                                                                                                                                                                                                                    
        IF LASTKEY() = 27                                                                                                                                                                                                                                                                                                                                                                       
                SET KEY -9 TO                                                                                                                                                                                                                                                                                                                                                                   
                RELEASE ALL                                                                                                                                                                                                                                                                                                                                                                     
	        wvw_lclosewindow()
                RETURN NIL                                                                                                                                                                                                                                                                                                                                                                      
        ENDIF                                                                                                                                                                                                                                                                                                                                                                                   
        cons_orcam:={}
        cComm  := "SELECT * FROM sacorcam WHERE sr_deleted = ' ' AND pnum_ped = "+sr_cdbvalue(STRZERO(mnum_orc,6))+" AND ppag IS NULL"
        sr_getconnection():exec(ccomm,,.t.,@cons_orcam)
        IF LEN(cons_orcam) = 0
                atencao('Neste ORCAMENTO nao tem nenhum PRODUTO para GERAR PEDIDO')
                LOOP
        ENDIF                                                                                                                                                                                                                                                                                                                                                                                           
                
        ali := 'ped_s'                                                                                                                                                                                                                                                                                                                                                                          
        no  := 'noped'                                                                                                                                                                                                                                                                                                                                                                          
        *****************************                                                                                                                                                                                                                                                                                                                                                           
        SELE('orcam');ORDSETFOCUS(1)                                                                                                                                                                                                                                                                                                                                                            
        GO TOP                                                                                                                                                                                                                                                                                                                                                                                  
        *****************************                                                                                                                                                                                                                                                                                                                                                           
        IF ! orcam->(DBSEEK(STRZERO(mnum_orc,6)))                                                                                                                                                                                                                                                                                                                                               
                atencao('Nao foi possivel encontrar este ORCAMENTO')                                                                                                                                                                                                                                                                                                                            
                LOOP                                                                                                                                                                                                                                                                                                                                                                            
        ELSE                                                                                                                                                                                                                                                                                                                                                                                    
                IF orcam->ppag = 'C'                                                                                                                                                                                                                                                                                                                                                            
                        atencao('ORCAMENTO CANCELADO')                                                                                                                                                                                                                                                                                                                                          
                        LOOP                                                                                                                                                                                                                                                                                                                                                                    
                ENDIF                                                                                                                                                                                                                                                                                                                                                                           
                IF orcam->pempresa <> mcodempresa .AND. mmult_emp = 'S'                                                                                                                                                                                                                                                                                                                         
                        atencao('Este ORCAMENTO nao faz parte desta EMPRESA:'+orcam->pempresa+' nao da EMPRESA em uso: '+mcodempresa+' mudar a emrpesa: ')                                                                                                                                                                                                                                          
                        LOOP                                                                                                                                                                                                                                                                                                                                                                    
                ENDIF                                                                                                                                                                                                                                                                                                                                                                           
                IF m_set[1,150] = 'S' .AND. EMPTY(orcam->plib_por)                                                                                                                                                                                                                                                                                                                              
                        atencao('Este ORCAMENTO nao foi LIBERADO')                                                                                                                                                                                                                                                                                                                              
                        LOOP                                                                                                                                                                                                                                                                                                                                                                    
                ENDIF                                                                                                                                                                                                                                                                                                                                                                           
                mposicao := RECNO()                                                                                                                                                                                                                                                                                                                                                             
		mcod_cli := VAL(orcam->pcod_cli)                                                                                                                                                                                                                                                                                                                                                
                op_tela(08,10,12,78,' SOLICITACAO DE CLIENTE ','*','1')                                                                                                                                                                                                                                                                                                                         
                IF ! AbriArq('saccli','cli');RETURN NIL;ENDIF                                                                                                                                                                                                                                                                                                                                   
                DEVPOS(01,00);DEVOUT('Cod.Cliente:')                                                                                                                                                                                                                                                                                                                                            
                DEVPOS(02,00);DEVOUT('Nome Fant..:')                                                                                                                                                                                                                                                                                                                                            
                DEVPOS(03,00);DEVOUT('Observacao.:')                                                                                                                                                                                                                                                                                                                                            
                setcor(3)                                                                                                                                                                                                                                                                                                                                                                       
		DEVPOS(01,13);DEVOUT(STR(mcod_cli))                                                                                                                                                                                                                                                                                                                                       
                *****************                                                                                                                                                                                                                                                                                                                                                               
                SELE('cli');ORDSETFOCUS(1)                                                                                                                                                                                                                                                                                                                                                      
                *****************                                                                                                                                                                                                                                                                                                                                                               
                IF ! cli->(DBSEEK(mcod_cli))                                                                                                                                                                                                                                                                                                                                         
                        atencao('Cliente nao cadastrado !!!')                                                                                                                                                                                                                                                                                                                                   
	                wvw_lclosewindow()                                                                                                                                                                                                                                                                                                                                                      
                        LOOP                                                                                                                                                                                                                                                                                                                                                                    
                ENDIF                                                                                                                                                                                                                                                                                                                                                                           
                setcor(3)                                                                                                                                                                                                                                                                                                                                                                       
                DEVPOS(01,13);DEVOUT(STR(cli->cod_cli,5))                                                                                                                                                                                                                                                                                                                                              
                DEVPOS(01,19);DEVOUT(cli->razao)                                                                                                                                                                                                                                                                                                                                                
                DEVPOS(02,19);DEVOUT(cli->nome)                                                                                                                                                                                                                                                                                                                                                 
                DEVPOS(03,13);DEVOUT(cli->obs)                                                                                                                                                                                                                                                                                                                                                  
                setcor(1)                                                                                                                                                                                                                                                                                                                                                                       
                IF cli->bloqueio = 'S'                                                                                                                                                                                                                                                                                                                                                          
                        atencao('Este CLIENTE ESTA COM CREDITO BLOQUEADO PELO SISTEMA')                                                                                                                                                                                                                                                                                                         
	                wvw_lclosewindow()                                                                                                                                                                                                                                                                                                                                                      
                        LOOP                                                                                                                                                                                                                                                                                                                                                                    
                ENDIF                                                                                                                                                                                                                                                                                                                                                                           
                IF ! spc(mcod_cli,0,'*')
	                wvw_lclosewindow()                                                                                                                                                                                                                                                                                                                                                      
                        LOOP                                                                                                                                                                                                                                                                                                                                                                    
                ENDIF                                                                                                                                                                                                                                                                                                                                                                           
                mdocum := cli_dup(mcod_cli)
                IF ! EMPTY(mdocum)
                        atencao('Existe estes documentos deste cliente: '+mdocum)
                ENDIF                                                                                                                                                                                                                                                                                                                                                                           
                ver_aniv(mcod_cli)                                                                                                                                                                                                                                                                                                                                                              
                opcao := op_simnao('S','Confirma o CLIENTE:')                                                                                                                                                                                                                                                                                                                                   
                IF opcao = 'N'                                                                                                                                                                                                                                                                                                                                                                  
	                wvw_lclosewindow()                                                                                                                                                                                                                                                                                                                                                      
                        LOOP                                                                                                                                                                                                                                                                                                                                                                    
                ENDIF                                                                                                                                                                                                                                                                                                                                                                           
	        wvw_lclosewindow()                                                                                                                                                                                                                                                                                                                                                              
                IF ver_serie() = '141235'
                        mlib := ' '
                        cons_orcam:={}
                        cComm  := "SELECT * FROM sacorcam WHERE sr_deleted = ' ' AND pnum_ped = "+sr_cdbvalue(STRZERO(mnum_orc,6))+" AND ppag IS NULL"
                        sr_getconnection():exec(ccomm,,.t.,@cons_orcam)
                        IF LEN(cons_orcam) > 0
                                i:=0
                                FOR i = 1 TO LEN(cons_orcam)
                                        cons_merc:={}
                                        cComm  := "SELECT * FROM sacmerc WHERE cod_merc = "+sr_cdbvalue(cons_orcam[i,6])
                                        sr_getconnection():exec(ccomm,,.t.,@cons_merc)
                                        IF LEN(cons_merc) = 0
                                                LOOP
                                        ENDIF
                                        IF cons_orcam[i,14] > cons_merc[1,56]
                                                atencao('Produto: '+cons_merc[1,8]+'-'+cons_merc[1,9]+' - '+'Saldo: '+TRANSFORM(cons_merc[1,56],ALLTRIM(m_set[1,99]))+' Quantidade Solicitada: '+TRANSFORM(cons_orcam[i,14],ALLTRIM(m_set[1,99]))+' maior que saldo disponivel')
                                                mlib := '*'                                                                                                                                                                                                                                                                                                                                             
                                                EXIT                                                                                                                                                                                                                                                                                                                                                    
                                        ENDIF                                                                                                                                                                                                                                                                                                                                                           
                                NEXT
                        ENDIF
                ENDIF                                                                                                                                                                                                                                                                                                                                                                           
                IF mlib = ' ';EXIT;ENDIF
        ENDIF
ENDDO
*****************************                                                                                                                                                                                                                                                                                                                                                           
SELE('orcam');ORDSETFOCUS(1)
GO mposicao
*****************************                                                                                                                                                                                                                                                                                                                                                           
mnum_os   := mnum_orc                                                                                                                                                                                                                                                                                                                                                                           
ver_cli(VAL(orcam->pcod_cli))                                                                                                                                                                                                                                                                                                                                                                   
mcod_aux  := cli->codvend                                                                                                                                                                                                                                                                                                                                                                       
mcod_vend := orcam->pcod_vend                                                                                                                                                                                                                                                                                                                                                                   
ver_ven(mcod_vend)                                                                                                                                                                                                                                                                                                                                                                              
mnome_ven := sen->snome                                                                                                                                                                                                                                                                                                                                                                         
mcod_cli := VAL(orcam->pcod_cli)                                                                                                                                                                                                                                                                                                                                                                
mcont_item := 0                                                                                                                                                                                                                                                                                                                                                                                 
mhoras := TIME()                                                                                                                                                                                                                                                                                                                                                                                
mtele_mark := orcam->pstat_item                                                                                                                                                                                                                                                                                                                                                                 
WHILE STRZERO(mnum_orc,6) = orcam->pnum_ped .AND. ! EOF()
        mlib := '*'                                                                                                                                                                                                                                                                                                                                                                             
        IF orcam->ppag = '*'
                SKIP;LOOP                                                                                                                                                                                                                                                                                                                                                                       
        ENDIF                                                                                                                                                                                                                                                                                                                                                                                   
        mlibera := ' '                                                                                                                                                                                                                                                                                                                                                                          
        msubtotal := mtot_ipi  := mtot_custo := mtot_ped := f := 0                                                                                                                                                                                                                                                                                                                              
        setcor(3)                                                                                                                                                                                                                                                                                                                                                                               
        DEVPOS(lba-1,cci+07);DEVOUT(STRZERO(mcont_item,3))                                                                                                                                                                                                                                                                                                                                      
        i = 1                                                                                                                                                                                                                                                                                                                                                                                   
        mmerc := orcam->pmerc                                                                                                                                                                                                                                                                                                                                                                   
*       mcod_bc := orcam->pcod_bar                                                                                                                                                                                                                                                                                                                                                              
        WHILE  i <= LEN(m_codigo)                                                                                                                                                                                                                                                                                                                                                               
                mlibera := ' '                                                                                                                                                                                                                                                                                                                                                                  
                IF m_codigo[i] = '     ' .OR. m_codigo[i] = NIL                                                                                                                                                                                                                                                                                                                                 
                        i++                                                                                                                                                                                                                                                                                                                                                                     
                        LOOP                                                                                                                                                                                                                                                                                                                                                                    
                ENDIF                                                                                                                                                                                                                                                                                                                                                                           
                msubtotal := msubtotal + iat((m_matriz[i,1] * m_matriz[i,2]),m_set[1,103])                                                                                                                                                                                                                                                                                                    
                mtot_custo:= mtot_custo + iat((m_matriz[i,1] * m_matriz[i,9]),m_set[1,103])                                                                                                                                                                                                                                                                                                   
                @ lba-1,cci+65 SAY msubtotal PICT ALLTRIM(m_set[1,98])                                                                                                                                                                                                                                                                                                                          
                i++                                                                                                                                                                                                                                                                                                                                                                             
        ENDDO                                                                                                                                                                                                                                                                                                                                                                                   

        i = 1                                                                                                                                                                                                                                                                                                                                                                                   
        IF f > 13                                                                                                                                                                                                                                                                                                                                                                               
                i := LEN(m_codigo) - 13                                                                                                                                                                                                                                                                                                                                                         
        ENDIF                                                                                                                                                                                                                                                                                                                                                                                   
        f = 0                                                                                                                                                                                                                                                                                                                                                                                   
        WHILE  i <= LEN(m_codigo)                                                                                                                                                                                                                                                                                                                                                               
                mlibera := ' '                                                                                                                                                                                                                                                                                                                                                                  
                IF m_codigo[i] = '     ' .OR. m_codigo[i] = NIL                                                                                                                                                                                                                                                                                                                                 
                        i++                                                                                                                                                                                                                                                                                                                                                                     
                        LOOP                                                                                                                                                                                                                                                                                                                                                                    
                ENDIF                                                                                                                                                                                                                                                                                                                                                                           
                setcor(3)                                                                                                                                                                                                                                                                                                                                                                       
                @ lci+3+f,cci+1 SAY m_codigo[i]                                                                                                                                                                                                                                                                                                                                                 
                IF m_matriz[i,6] = 'EV'                                                                                                                                                                                                                                                                                                                                                         
                        @ lci+3+f,COL()+1 SAY LEFT(m_matriz[i,5],28)                                                                                                                                                                                                                                                                                                                            
                        @ lci+3+f,COL()+1 SAY m_matriz[i,24]                                                                                                                                                                                                                                                                                                                                    
                ELSE                                                                                                                                                                                                                                                                                                                                                                            
                        IF ! EMPTY(m_matriz[i,28])                                                                                                                                                                                                                                                                                                                                              
                                @ lci+3+f,COL()+1 SAY LEFT(m_matriz[i,5],18)                                                                                                                                                                                                                                                                                                                    
                                @ lci+3+f,COL()+1 SAY m_matriz[i,28]                                                                                                                                                                                                                                                                                                                            
                        ELSE                                                                                                                                                                                                                                                                                                                                                                    
                                @ lci+3+f,COL()+1 SAY LEFT(m_matriz[i,5],39)                                                                                                                                                                                                                                                                                                                    
                        ENDIF                                                                                                                                                                                                                                                                                                                                                                   
                ENDIF                                                                                                                                                                                                                                                                                                                                                                           
                @ lci+3+f,COL()+1 SAY m_matriz[i,1] PICT '99999.99'                                                                                                                                                                                                                                                                                                                             
                @ lci+3+f,COL()+1 SAY m_matriz[i,2] PICT ALLTRIM(m_set[1,98])                                                                                                                                                                                                                                                                                                                   
                @ lci+3+f,COL()+1 SAY m_matriz[i,2] * m_matriz[i,1] PICT ALLTRIM(m_set[1,98])                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                
                IF f > 13                                                                                                                                                                                                                                                                                                                                                                       
                        i++                                                                                                                                                                                                                                                                                                                                                                     
                ELSE                                                                                                                                                                                                                                                                                                                                                                            
                        i++                                                                                                                                                                                                                                                                                                                                                                     
                        f++                                                                                                                                                                                                                                                                                                                                                                     
                ENDIF                                                                                                                                                                                                                                                                                                                                                                           
        ENDDO                                                                                                                                                                                                                                                                                                                                                                                   
        mcomissao := orcam->pcomissao
        mcod_merc := mdesconto := mvlr_fat := 0
        menvelope := SPACE(10)
        f4 := ' '
        limpa(lba-3,cci+1,lba-3,cba-1)                                                                                                                                                                                                                                                                                                                                                          
        mcod_merc := VAL(orcam->pcod_merc)                                                                                                                                                                                                                                                                                                                                                      
        IF ! ver_cod(mcod_merc)                                                                                                                                                                                                                                                                                                                                                                 
                SKIP;LOOP                                                                                                                                                                                                                                                                                                                                                                       
        ENDIF                                                                                                                                                                                                                                                                                                                                                                                   
*       *************                                                                                                                                                                                                                                                                                                                                                                           
*       SELE('merc');ORDSETFOCUS(1)                                                                                                                                                                                                                                                                                                                                                             
*       GO TOP                                                                                                                                                                                                                                                                                                                                                                                  
*       *************                                                                                                                                                                                                                                                                                                                                                                           
*       merc->(DBSEEK(mcod_merc))                                                                                                                                                                                                                                                                                                                                                    
        setcor(3)                                                                                                                                                                                                                                                                                                                                                                               
        DEVPOS(lba-3,cci+01);DEVOUT(mcod_merc)                                                                                                                                                                                                                                                                                                                                       
        DEVPOS(lba-3,cci+07);DEVOUT(orcam->pmerc)                                                                                                                                                                                                                                                                                                                                               
        DEVPOS(lba-3,cci+46);DEVOUTPICT(orcam->pquantd,ALLTRIM(m_set[1,99]))                                                                                                                                                                                                                                                                                                                    
        DEVPOS(lba-3,cci+57);DEVOUTPICT(orcam->pvlr_fat,ALLTRIM(m_set[1,98]))                                                                                                                                                                                                                                                                                                                   
        DEVPOS(lba-1,cci+20);DEVOUTPICT(merc->saldo_mer,'99,999,999.99')                                                                                                                                                                                                                                                                                                                        
        setcor(1)                                                                                                                                                                                                                                                                                                                                                                               
        DEVPOS(lba-1,cci+13);DEVOUT('Saldo:')                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                
        IF ! EMPTY(merc->est_min) .AND. merc->est_min >= (merc->saldo_mer - orcam->pquantd) .AND. merc->merc <> 'DIVERSOS' .AND. m_set[1,107] = 'S' .AND. m_indiv[1,26] <> 'T'                                                                                                                                                                                                                      
                atencao('SALDO: '+TRANSFORM(merc->saldo_mer,ALLTRIM(m_set[1,99]))+' esta menor que o ESTOQUE MINIMO: '+TRANSFORM(merc->est_min,'9,999,999.99')+' estipulado !!!')                                                                                                                                                                                                               
        ENDIF                                                                                                                                                                                                                                                                                                                                                                                   
        **********                                                                                                                                                                                                                                                                                                                                                                              
        SELE('orcam');ORDSETFOCUS(1)                                                                                                                                                                                                                                                                                                                                                            
        **********                                                                                                                                                                                                                                                                                                                                                                              
	mquantd := orcam->pquantd
        @ lba-3,cci+46 GET mquantd PICT ALLTRIM(m_set[1,99])
        READ
	IF LASTKEY() = 27 .OR. mquantd = 0
		SKIP
		LOOP
	ENDIF
        IF orcam->pquantd > merc->saldo_mer .AND. m_set[1,107] = 'S'
                atencao('Produto: '+STRZERO(mcod_merc,5)+'-'+merc->merc+' - '+'Saldo: '+TRANSFORM(merc->saldo_mer,ALLTRIM(m_set[1,99]))+' Quantidade Solicitada: '+TRANSFORM(orcam->pquantd,ALLTRIM(m_set[1,99]))+' maior que saldo')
                setcor(1)
		IF mquantd > merc->saldo_mer .AND. m_set[1,107] = 'S'                                                                                                                                                                                                                                                                                                                           
                        mlib := ' '                                                                                                                                                                                                                                                                                                                                                             
                        IF ! aut_sen('Produto: '+STRZERO(mcod_merc,5)+'-'+merc->merc+' - '+'Saldo: '+TRANSFORM(merc->saldo_mer,ALLTRIM(m_set[1,99]))+' Quantidade Solicitada: '+TRANSFORM(orcam->pquantd,ALLTRIM(m_set[1,99]))+' maior que saldo... Senha de autorizacao:','LIB_SALDO',10)
                                SKIP
				LOOP
                        ENDIF                                                                                                                                                                                                                                                                                                                                                                   
                        mlibera := 'S'                                                                                                                                                                                                                                                                                                                                                          
                ENDIF                                                                                                                                                                                                                                                                                                                                                                           
        ENDIF                                                                                                                                                                                                                                                                                                                                                                                   
        IF orcam->ppre_venda > orcam->pvlr_fat                                                                                                                                                                                                                                                                                                                                                  
                IF ((orcam->ppre_venda - orcam->pvlr_fat)/orcam->ppre_venda)*100 > m_set[1,33] .AND. EMPTY(merc->desc_merc)
                        mlib := ' '                                                                                                                                                                                                                                                                                                                                                             
                        IF ! aut_sen('Produto: '+STRZERO(mcod_merc,5)+'-'+merc->merc+' - '+TRANSFORM(((orcam->ppre_venda - orcam->pvlr_fat)/orcam->ppre_venda)*100,'999.99')+'% Desconto nao e permitido.. senha autorizacao:','LIB_DESC')                                                                                                                                                      
                                setcor(1)                                                                                                                                                                                                                                                                                                                                                       
                                SKIP
				LOOP
                        ENDIF                                                                                                                                                                                                                                                                                                                                                                   
                ELSEIF ((orcam->ppre_venda - orcam->pvlr_fat)/orcam->ppre_venda)*100 > merc->desc_merc .AND. ! EMPTY(merc->desc_merc)                                                                                                                                                                                                                                                           
                        mlib := ' '                                                                                                                                                                                                                                                                                                                                                             
                        IF ! aut_sen('Produto: '+STRZERO(mcod_merc,5)+'-'+merc->merc+' - '+TRANSFORM(((orcam->ppre_venda - orcam->pvlr_fat)/orcam->ppre_venda)*100,'999.99')+'% Desconto nao e permitido.. senha autorizacao:','LIB_DESC')                                                                                                                                                      
                                setcor(1)                                                                                                                                                                                                                                                                                                                                                       
                                SKIP
				LOOP
                        ENDIF                                                                                                                                                                                                                                                                                                                                                                   
                ELSEIF m_set[1,38] = 'C'                                                                                                                                                                                                                                                                                                                                                        
                        mlib := ' '                                                                                                                                                                                                                                                                                                                                                             
                        IF orcam->pvlr_fat < orcam->pcust_real                                                                                                                                                                                                                                                                                                                                  
                                IF ! aut_sen('Produto: '+STRZERO(mcod_merc,5)+'-'+merc->merc+' - '+'Senha de autorizacao:','LIB_DESC')                                                                                                                                                                                                                                                          
                                        setcor(1)                                                                                                                                                                                                                                                                                                                                               
                                        SKIP
					LOOP
                                ENDIF                                                                                                                                                                                                                                                                                                                                                           
                        ENDIF                                                                                                                                                                                                                                                                                                                                                                   
                ELSEIF m_set[1,38] = 'V'                                                                                                                                                                                                                                                                                                                                                        
                        mlib := ' '                                                                                                                                                                                                                                                                                                                                                             
                        IF orcam->pvlr_fat < orcam->ppre_venda                                                                                                                                                                                                                                                                                                                                  
                                IF ! aut_sen('Produto: '+STRZERO(mcod_merc,5)+'-'+merc->merc+' - '+'Senha de autorizacao:','LIB_DESC')                                                                                                                                                                                                                                                          
                                        SKIP
					LOOP
                                ENDIF                                                                                                                                                                                                                                                                                                                                                           
                        ENDIF                                                                                                                                                                                                                                                                                                                                                                   
                ENDIF                                                                                                                                                                                                                                                                                                                                                                           
        ENDIF                                                                                                                                                                                                                                                                                                                                                                                   
        IF m_set[1,115] = 'S'                                                                                                                                                                                                                                                                                                                                                                   
                mensagem('Digite o percentual de Comissao do Vendedor [%]:')
                @ 23,COL()+1 GET mcomissao PICT '999.99' VALID IF(EMPTY(mcomissao),.F.,.T.)                                                                                                                                                                                                                                                                                                     
                READ                                                                                                                                                                                                                                                                                                                                                                            
                IF LASTKEY() = 27                                                                                                                                                                                                                                                                                                                                                               
                        SKIP
			LOOP
                ENDIF                                                                                                                                                                                                                                                                                                                                                                           
        ENDIF                                                                                                                                                                                                                                                                                                                                                                                   
        opcao := op_simnao('S','Confirma Inclusao da Mercadoria:')                                                                                                                                                                                                                                                                                                                              
        IF opcao = 'N'
                **********                                                                                                                                                                                                                                                                                                                                                                      
                SELE('merc');ORDSETFOCUS(1)                                                                                                                                                                                                                                                                                                                                                     
                **********                                                                                                                                                                                                                                                                                                                                                                      
                IF ali = 'ped_s'
                        i := 0                                                                                                                                                                                                                                                                                                                                                                  
                        FOR i = 1 TO LEN(m_codigo)
                                IF EMPTY(m_codigo[i]) .OR. m_codigo[i] = NIL
                                        LOOP
                                ENDIF
                                aret:={}
                                IF mproducao = 'N'
                                        cComm  := "SELECT saldo_est FROM sacmerc WHERE cod_merc = "+sr_cdbvalue(m_codigo[i])
                                        sr_getconnection():exec(ccomm,,.t.,@aret)
                                        ccomm :="UPDATE sacmerc SET saldo_est = "+sr_cdbvalue(aret[1,1] + m_matriz[i,1]) +" WHERE cod_merc = "+sr_cdbvalue(m_codigo[i])
                                        sr_getconnection():exec(ccomm,,.f.)
                                ELSE
                                        cComm  := "SELECT saldo_mer FROM sacmerc WHERE cod_merc = "+sr_cdbvalue(m_codigo[i])
                                        sr_getconnection():exec(ccomm,,.t.,@aret)
                                        ccomm :="UPDATE sacmerc SET saldo_mer = "+sr_cdbvalue(aret[1,1] + m_matriz[i,1])+",data_atu = "+sr_cdbvalue(mdata_sis)+" WHERE cod_merc = "+sr_cdbvalue(m_codigo[i])
                                        sr_getconnection():exec(ccomm,,.f.)
                                        sr_getconnection():exec('INSERT INTO logproduto (data_sis,data,'+;
                                                'hora,cod_prod,quantd,saldo_ant,saldo_pos,cod_oper,prog,terminal,'+;
                                                'processo,ent_sai,SR_DELETED )'+;
                                                ' VALUES ('+;
                                                sr_cdbvalue(DATE())+','+; //1
                                                sr_cdbvalue(mdata_sis)+','+; //2
                                                sr_cdbvalue(TIME())+','+; //3
                                                sr_cdbvalue(m_codigo[i])+','+; //4
                                                sr_cdbvalue(m_matriz[i,1])+','+; //5
                                                sr_cdbvalue(aret[1,1])+','+; //6
                                                sr_cdbvalue(aret[1,1] + m_matriz[i,1])+','+; //7
                                                sr_cdbvalue(cod_operado)+','+; //8
                                                sr_cdbvalue('SACTPORC')+','+; //9
                                                sr_cdbvalue(LEFT(NETNAME(),15))+','+; //12
                                                sr_cdbvalue('PROD. N CONF.ORCA.:'+STRZERO(mnum_orc,6))+','+; //11
                                                sr_cdbvalue('E')+','+; //11
                                                sr_cdbvalue(' ')+')',,.f.)
                                ENDIF
                        NEXT
                        sr_getconnection():exec("COMMIT",,.f.)
                ENDIF
                **********                                                                                                                                                                                                                                                                                                                                                                      
                SELE('merc');ORDSETFOCUS(1)                                                                                                                                                                                                                                                                                                                                                     
                **********                                                                                                                                                                                                                                                                                                                                                                      
                ASIZE(m_codigo,0)                                                                                                                                                                                                                                                                                                                                                               
                ASIZE(m_matriz,0)                                                                                                                                                                                                                                                                                                                                                               
                RESTSCREEN(00,00,24,79,tela)                                                                                                                                                                                                                                                                                                                                                    
                **** apagando VARIAVEIS PRIVATE *****                                                                                                                                                                                                                                                                                                                                           
                RELEASE ALL                                                                                                                                                                                                                                                                                                                                                                     
                SET KEY -9 TO                                                                                                                                                                                                                                                                                                                                                                   
                wvw_lclosewindow()                                                                                                                                                                                                                                                                                                                                                              
                RETURN NIL                                                                                                                                                                                                                                                                                                                                                                      
        ENDIF                                                                                                                                                                                                                                                                                                                                                                                   
        IF opcao = 'S'                                                                                                                                                                                                                                                                                                                                                                          
                mensagem('Atualizando o Saldo do Produto...')							
                aret:={}
                cComm  := "SELECT saldo_mer,saldo_est FROM sacmerc WHERE cod_merc = "+sr_cdbvalue(mcod_merc)
                sr_getconnection():exec(ccomm,,.t.,@aret)
                IF LEN(aret) > 0
                        IF mquantd > aret[1,1] .AND. m_set[1,107] = 'S' .AND. mlibera = ' '
                                IF ! aut_sen('Sld:'+TRANSFORM(aret[1,1],ALLTRIM(m_set[1,98]))+'-Ped:'+TRANSFORM(orcam->pquantd,'99999.99')+'-Aut.:','LIB_SALDO')
                                        DBUNLOCKALL()                                                                                                                                                                                                                                                                                                                                                   
                                        LOOP                                                                                                                                                                                                                                                                                                                                                            
                                ENDIF                                                                                                                                                                                                                                                                                                                                                                   
                        ENDIF                                                                                                                                                                                                                                                                                                                                                                           
                        mensagem('CALCULANDO O DESCONTO ...')
                        cons_p:={}
                        cComm  := "SELECT * FROM sacorcam WHERE sr_deleted = ' ' AND pcod_merc = "+sr_cdbvalue(mcod_merc)
                        ccomm  := ccomm + " AND pnum_ped = "+sr_cdbvalue(STRZERO(mnum_orc,6))
                        sr_getconnection():exec(ccomm,,.t.,@cons_p)

                        IF cons_p[1,18] < cons_p[1,20]
                                mdesconto := ((cons_p[1,20]-cons_p[1,18])/cons_p[1,20])*100
                        ENDIF

                        IF mproducao = 'N'
                                ccomm :="UPDATE sacmerc SET saldo_est = "+sr_cdbvalue(aret[1,2] - mquantd) +" WHERE cod_merc = "+sr_cdbvalue(mcod_merc)
                                sr_getconnection():exec(ccomm,,.f.)
                        ELSE
                                ccomm :="UPDATE sacmerc SET saldo_mer = "+sr_cdbvalue(aret[1,1] - mquantd)+",data_atu = "+sr_cdbvalue(mdata_sis)+" WHERE cod_merc = "+sr_cdbvalue(mcod_merc)
                                sr_getconnection():exec(ccomm,,.f.)
                                sr_getconnection():exec('INSERT INTO logproduto (data_sis,data,'+;
                                                'hora,cod_prod,quantd,saldo_ant,saldo_pos,cod_oper,prog,terminal,'+;
                                                'processo,ent_sai,SR_DELETED )'+;
                                                ' VALUES ('+;
                                                sr_cdbvalue(DATE())+','+; //1
                                                sr_cdbvalue(mdata_sis)+','+; //2
                                                sr_cdbvalue(TIME())+','+; //3
                                                sr_cdbvalue(mcod_merc)+','+; //4
                                                sr_cdbvalue(mquantd)+','+; //5
                                                sr_cdbvalue(aret[1,1])+','+; //6
                                                sr_cdbvalue(aret[1,1] - mquantd)+','+; //7
                                                sr_cdbvalue(cod_operado)+','+; //8
                                                sr_cdbvalue('SACTPORC')+','+; //9
                                                sr_cdbvalue(LEFT(NETNAME(),15))+','+; //12
                                                sr_cdbvalue('PROD. CONF.ORC.:'+STRZERO(mnum_orc,6))+','+; //11
                                                sr_cdbvalue('S')+','+; //11
                                                sr_cdbvalue(' ')+')',,.f.)
                        ENDIF
                        sr_getconnection():exec("COMMIT",,.f.)
                ELSE                                                                                                                                                                                                                                                                                                                                                                            
                        atencao('Nao foi possivel atualizar saldo da mercadoria, Digite novamente')                                                                                                                                                                                                                                                                                             
                        LOOP                                                                                                                                                                                                                                                                                                                                                                    
                ENDIF
                AADD(m_merc,orcam->pmerc)
                AADD(m_codigo,orcam->pcod_merc)                                                                                                                                                                                                                                                                                                                                                 
                mhoras := TIME()                                                                                                                                                                                                                                                                                                                                                                
                mvlr_fat := orcam->pvlr_fat                                                                                                                                                                                                                                                                                                                                                     
                IF orcam->pvlr_fat = 0                                                                                                                                                                                                                                                                                                                                                          
                *                            1               2             3           4              5             6             7          8       9             10             11              12               13              14           15             16            17              18              19           20          21            22           23               24            5          26              27                28
                *             29           30               31            32           33             34             35            36           37                   38                  39                40          41         42            43                                                                                                                                              
                        AADD(m_matriz,{mquantd,orcam->pvlr_fat,        0,orcam->pgru_sub,orcam->pmerc,orcam->punidade,orcam->ppeso,       0,        0,orcam->pcod_fab,orcam->pfabrica,orcam->palimento,orcam->pisento,orcam->ppromocao,mcomissao,orcam->pbebida,orcam->ppeso_liq,orcam->pcust_merc,orcam->pobs1,orcam->pobs2,orcam->plocal,orcam->pipi,orcam->pespecie,orcam->penvelope,mhoras,orcam->pind_icms,orcam->psit_trib,orcam->chassis,;
                        orcam->descri1,orcam->descri2,orcam->descri3,orcam->descri4,orcam->descri5,orcam->pprazo,orcam->pgramatura,' ',VAL(orcam->pmontador),VAL(orcam->pmontador1),orcam->pcom_mont,orcam->ppr_venda1,'  ',orcam->ppacote,orcam->ppecas,VAL(orcam->cod_pres)})
                ELSE                                                                                                                                                                                                                                                                                                                                                                            
                        AADD(m_matriz,{mquantd,orcam->pvlr_fat,mdesconto,orcam->pgru_sub,orcam->pmerc,orcam->punidade,orcam->ppeso,orcam->ppre_venda,orcam->pcust_real,orcam->pcod_fab,orcam->pfabrica,orcam->palimento,orcam->pisento,orcam->ppromocao,mcomissao,orcam->pbebida,orcam->ppeso_liq,orcam->pcust_merc,orcam->pobs1,orcam->pobs2,orcam->plocal,orcam->pipi,orcam->pespecie,orcam->penvelope,mhoras,orcam->pind_icms,orcam->psit_trib,orcam->chassis,;
                        orcam->descri1,orcam->descri2,orcam->descri3,orcam->descri4,orcam->descri5,orcam->pprazo,orcam->pgramatura,' ',VAL(orcam->pmontador),VAL(orcam->pmontador1),orcam->pcom_mont,orcam->ppr_venda1,'  ',orcam->ppacote,orcam->ppecas,VAL(orcam->cod_pres)})
                ENDIF                                                                                                                                                                                                                                                                                                                                                                           
                mcont_item ++
                mquantd := 1                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                
                **********                                                                                                                                                                                                                                                                                                                                                                      
                SELE('orcam');ORDSETFOCUS(1)                                                                                                                                                                                                                                                                                                                                                    
                SKIP
                **********                                                                                                                                                                                                                                                                                                                                                                      
        ENDIF                                                                                                                                                                                                                                                                                                                                                                                   
ENDDO                                                                                                                                                                                                                                                                                                                                                                                           
IF EMPTY(m_codigo)                                                                                                                                                                                                                                                                                                                                                                              
        atencao('Neste ORCAMENTO nao tem nenhum PRODUTO para GERAR PEDIDO')
        RESTSCREEN(00,00,24,79,tela)                                                                                                                                                                                                                                                                                                                                                            
        wvw_lclosewindow()                                                                                                                                                                                                                                                                                                                                                                      
        RETURN NIL                                                                                                                                                                                                                                                                                                                                                                              
ENDIF                                                                                                                                                                                                                                                                                                                                                                                           
i = 1                                                                                                                                                                                                                                                                                                                                                                                   
IF f > 13                                                                                                                                                                                                                                                                                                                                                                               
        i := LEN(m_codigo) - 13                                                                                                                                                                                                                                                                                                                                                         
ENDIF                                                                                                                                                                                                                                                                                                                                                                                   
f = 0                                                                                                                                                                                                                                                                                                                                                                                   
WHILE  i <= LEN(m_codigo)                                                                                                                                                                                                                                                                                                                                                               
        mlibera := ' '                                                                                                                                                                                                                                                                                                                                                                  
        IF m_codigo[i] = '     ' .OR. m_codigo[i] = NIL                                                                                                                                                                                                                                                                                                                                 
                i++                                                                                                                                                                                                                                                                                                                                                                     
                LOOP                                                                                                                                                                                                                                                                                                                                                                    
        ENDIF                                                                                                                                                                                                                                                                                                                                                                           
        setcor(3)                                                                                                                                                                                                                                                                                                                                                                       
        @ lci+3+f,cci+1 SAY m_codigo[i]                                                                                                                                                                                                                                                                                                                                                 
        IF m_matriz[i,6] = 'EV'                                                                                                                                                                                                                                                                                                                                                         
                @ lci+3+f,COL()+1 SAY LEFT(m_matriz[i,5],28)                                                                                                                                                                                                                                                                                                                            
                @ lci+3+f,COL()+1 SAY m_matriz[i,24]                                                                                                                                                                                                                                                                                                                                    
        ELSE                                                                                                                                                                                                                                                                                                                                                                            
                IF ! EMPTY(m_matriz[i,28])                                                                                                                                                                                                                                                                                                                                              
                        @ lci+3+f,COL()+1 SAY LEFT(m_matriz[i,5],18)                                                                                                                                                                                                                                                                                                                    
                        @ lci+3+f,COL()+1 SAY m_matriz[i,28]                                                                                                                                                                                                                                                                                                                            
                ELSE                                                                                                                                                                                                                                                                                                                                                                    
                        @ lci+3+f,COL()+1 SAY LEFT(m_matriz[i,5],39)                                                                                                                                                                                                                                                                                                                    
                ENDIF                                                                                                                                                                                                                                                                                                                                                                   
        ENDIF                                                                                                                                                                                                                                                                                                                                                                           
        @ lci+3+f,COL()+1 SAY m_matriz[i,1] PICT '99999.99'                                                                                                                                                                                                                                                                                                                             
        @ lci+3+f,COL()+1 SAY m_matriz[i,2] PICT ALLTRIM(m_set[1,98])                                                                                                                                                                                                                                                                                                                   
        @ lci+3+f,COL()+1 SAY m_matriz[i,2] * m_matriz[i,1] PICT ALLTRIM(m_set[1,98])                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                        
        IF f > 13                                                                                                                                                                                                                                                                                                                                                                       
                i++                                                                                                                                                                                                                                                                                                                                                                     
        ELSE                                                                                                                                                                                                                                                                                                                                                                            
                i++                                                                                                                                                                                                                                                                                                                                                                     
                f++                                                                                                                                                                                                                                                                                                                                                                     
        ENDIF                                                                                                                                                                                                                                                                                                                                                                           
ENDDO                                                                                                                                                                                                                                                                                                                                                                                   
i := 0                                                                                                                                                                                                                                                                                                                                                                                  
FOR i = 1 TO LEN(m_codigo)
        sr_getconnection():exec("UPDATE sacorcam SET ppag = '*',pdatapag ="+sr_cdbvalue(mdata_sis)+" WHERE pnum_ped = "+sr_cdbvalue(STRZERO(mnum_orc,6))+" AND pcod_merc = "+sr_cdbvalue(m_codigo[i]),,.f.)
NEXT
sr_getconnection():exec('COMMIT',,.f.)
opcao := op_simnao('S','Confirma o Fechamento do pedidos:')
IF opcao = 'N'
        **********
        SELE('merc');ORDSETFOCUS(1)
        **********
        i := 0
        FOR i = 1 TO LEN(m_codigo)
                IF EMPTY(m_codigo[i]) .OR. m_codigo[i] = NIL
                        LOOP
                ENDIF
                aret:={}
                IF mproducao = 'N'
                        cComm  := "SELECT saldo_est FROM sacmerc WHERE cod_merc = "+sr_cdbvalue(m_codigo[i])
                        sr_getconnection():exec(ccomm,,.t.,@aret)
                        ccomm :="UPDATE sacmerc SET saldo_est = "+sr_cdbvalue(aret[1,1] + m_matriz[i,1]) +" WHERE cod_merc = "+sr_cdbvalue(m_codigo[i])
                        sr_getconnection():exec(ccomm,,.f.)
                ELSE
                        cComm  := "SELECT saldo_mer FROM sacmerc WHERE cod_merc = "+sr_cdbvalue(m_codigo[i])
                        sr_getconnection():exec(ccomm,,.t.,@aret)
                        ccomm :="UPDATE sacmerc SET saldo_mer = "+sr_cdbvalue(aret[1,1] + m_matriz[i,1])+",data_atu = "+sr_cdbvalue(mdata_sis)+" WHERE cod_merc = "+sr_cdbvalue(m_codigo[i])
                        sr_getconnection():exec(ccomm,,.f.)
                        sr_getconnection():exec('INSERT INTO logproduto (data_sis,data,'+;
                                                'hora,cod_prod,quantd,saldo_ant,saldo_pos,cod_oper,prog,terminal,'+;
                                                'processo,ent_sai,SR_DELETED )'+;
                                                ' VALUES ('+;
                                                sr_cdbvalue(DATE())+','+; //1
                                                sr_cdbvalue(mdata_sis)+','+; //2
                                                sr_cdbvalue(TIME())+','+; //3
                                                sr_cdbvalue(m_codigo[i])+','+; //4
                                                sr_cdbvalue(m_matriz[i,1])+','+; //5
                                                sr_cdbvalue(aret[1,1])+','+; //6
                                                sr_cdbvalue(aret[1,1] + m_matriz[i,1])+','+; //7
                                                sr_cdbvalue(cod_operado)+','+; //8
                                                sr_cdbvalue('SACTPORC')+','+; //9
                                                sr_cdbvalue(LEFT(NETNAME(),15))+','+; //12
                                                sr_cdbvalue('NAO CONF. ORC./PED.:'+STRZERO(mnum_orc,6))+','+; //11
                                                sr_cdbvalue('E')+','+; //11
                                                sr_cdbvalue(' ')+')',,.f.)
                ENDIF
                sr_getconnection():exec("COMMIT",,.f.)
        NEXT
        i := 0
        FOR i = 1 TO LEN(m_codigo)                                                                                                                                                                                                                                                                                                                                                              
                IF EMPTY(m_codigo[i]) .OR. m_codigo[i] = NIL                                                                                                                                                                                                                                                                                                                                    
                        LOOP                                                                                                                                                                                                                                                                                                                                                                    
                ENDIF                                                                                                                                                                                                                                                                                                                                                                           
                **********                                                                                                                                                                                                                                                                                                                                                                      
                SELE('orcam');ORDSETFOCUS(1)                                                                                                                                                                                                                                                                                                                                                    
                GO TOP                                                                                                                                                                                                                                                                                                                                                                          
                **********                                                                                                                                                                                                                                                                                                                                                                      
                IF ! orcam->(DBSEEK(STRZERO(mnum_orc,6)+m_codigo[i]));LOOP;ENDIF                                                                                                                                                                                                                                                                                                                
                IF ! BLOQREG();LOOP;ENDIF                                                                                                                                                                                                                                                                                                                                                       
                orcam->ppag := ' '                                                                                                                                                                                                                                                                                                                                                              
                orcam->pdatapag := CTOD('  /  /  ')                                                                                                                                                                                                                                                                                                                                             
                DBCOMMIT()                                                                                                                                                                                                                                                                                                                                                                      
                DBUNLOCK()                                                                                                                                                                                                                                                                                                                                                                      
        NEXT                                                                                                                                                                                                                                                                                                                                                                                    
        **********                                                                                                                                                                                                                                                                                                                                                                              
        SELE('merc');ORDSETFOCUS(1)                                                                                                                                                                                                                                                                                                                                                             
        **********                                                                                                                                                                                                                                                                                                                                                                              
        ASIZE(m_codigo,0)                                                                                                                                                                                                                                                                                                                                                                       
        ASIZE(m_merc,0)                                                                                                                                                                                                                                                                                                                                                                         
        ASIZE(m_matriz,0)                                                                                                                                                                                                                                                                                                                                                                       
        RESTSCREEN(00,00,24,79,tela)                                                                                                                                                                                                                                                                                                                                                            
        **** apagando VARIAVEIS PRIVATE *****                                                                                                                                                                                                                                                                                                                                                   
        RELEASE ALL                                                                                                                                                                                                                                                                                                                                                                             
        SET KEY -9 TO                                                                                                                                                                                                                                                                                                                                                                           
        wvw_lclosewindow()                                                                                                                                                                                                                                                                                                                                                                      
        RETURN NIL                                                                                                                                                                                                                                                                                                                                                                              
ENDIF                                                                                                                                                                                                                                                                                                                                                                                           
*****************************                                                                                                                                                                                                                                                                                                                                                                   
SELE('orcam');ORDSETFOCUS(1)                                                                                                                                                                                                                                                                                                                                                                    
GO TOP                                                                                                                                                                                                                                                                                                                                                                                          
*****************************                                                                                                                                                                                                                                                                                                                                                                   
orcam->(DBSEEK(STRZERO(mnum_orc,6)))                                                                                                                                                                                                                                                                                                                                                            

//fecha_pd('1',100,'*')
fecha_tp('1',100,'*')
CLEAR GETS                                                                                                                                                                                                                                                                                                                                                                                      
IF EMPTY(mnum_ped)                                                                                                                                                                                                                                                                                                                                                                              
        i := 0                                                                                                                                                                                                                                                                                                                                                                                  
        FOR i = 1 TO LEN(m_codigo)
                IF EMPTY(m_codigo[i]) .OR. m_codigo[i] = NIL
                        LOOP                                                                                                                                                                                                                                                                                                                                                                    
                ENDIF                                                                                                                                                                                                                                                                                                                                                                           
                aret:={}
                IF mproducao = 'N'
                        cComm  := "SELECT saldo_est FROM sacmerc WHERE cod_merc = "+sr_cdbvalue(m_codigo[i])
                        sr_getconnection():exec(ccomm,,.t.,@aret)
                        ccomm :="UPDATE sacmerc SET saldo_est = "+sr_cdbvalue(aret[1,1] + m_matriz[i,1]) +" WHERE cod_merc = "+sr_cdbvalue(m_codigo[i])
                        sr_getconnection():exec(ccomm,,.f.)
                ELSE
                        cComm  := "SELECT saldo_mer FROM sacmerc WHERE cod_merc = "+sr_cdbvalue(m_codigo[i])
                        sr_getconnection():exec(ccomm,,.t.,@aret)
                        ccomm :="UPDATE sacmerc SET saldo_mer = "+sr_cdbvalue(aret[1,1] + m_matriz[i,1])+",data_atu = "+sr_cdbvalue(mdata_sis)+" WHERE cod_merc = "+sr_cdbvalue(m_codigo[i])
                        sr_getconnection():exec(ccomm,,.f.)
                        sr_getconnection():exec('INSERT INTO logproduto (data_sis,data,'+;
                                                'hora,cod_prod,quantd,saldo_ant,saldo_pos,cod_oper,prog,terminal,'+;
                                                'processo,ent_sai,SR_DELETED )'+;
                                                ' VALUES ('+;
                                                sr_cdbvalue(DATE())+','+; //1
                                                sr_cdbvalue(mdata_sis)+','+; //2
                                                sr_cdbvalue(TIME())+','+; //3
                                                sr_cdbvalue(m_codigo[i])+','+; //4
                                                sr_cdbvalue(m_matriz[i,1])+','+; //5
                                                sr_cdbvalue(aret[1,1])+','+; //6
                                                sr_cdbvalue(aret[1,1] + m_matriz[i,1])+','+; //7
                                                sr_cdbvalue(cod_operado)+','+; //8
                                                sr_cdbvalue('SACTPORC')+','+; //9
                                                sr_cdbvalue(LEFT(NETNAME(),15))+','+; //12
                                                sr_cdbvalue('NAO GEROU No.PED.:'+STRZERO(mnum_orc,6))+','+; //11
                                                sr_cdbvalue('E')+','+; //11
                                                sr_cdbvalue(' ')+')',,.f.)
                ENDIF
                sr_getconnection():exec("COMMIT",,.f.)
        NEXT
        i := 0
        FOR i = 1 TO LEN(m_codigo)                                                                                                                                                                                                                                                                                                                                                              
                IF EMPTY(m_codigo[i]) .OR. m_codigo[i] = NIL                                                                                                                                                                                                                                                                                                                                    
                        LOOP                                                                                                                                                                                                                                                                                                                                                                    
                ENDIF                                                                                                                                                                                                                                                                                                                                                                           
                **********                                                                                                                                                                                                                                                                                                                                                                      
                SELE('orcam');ORDSETFOCUS(1)                                                                                                                                                                                                                                                                                                                                                    
                GO TOP                                                                                                                                                                                                                                                                                                                                                                          
                **********                                                                                                                                                                                                                                                                                                                                                                      
                IF ! orcam->(DBSEEK(STRZERO(mnum_orc,6)+m_codigo[i]));LOOP;ENDIF                                                                                                                                                                                                                                                                                                                
                IF ! BLOQREG();LOOP;ENDIF                                                                                                                                                                                                                                                                                                                                                       
                orcam->ppag := ' '                                                                                                                                                                                                                                                                                                                                                              
                orcam->pdatapag := CTOD('  /  /  ')                                                                                                                                                                                                                                                                                                                                             
                DBCOMMIT()                                                                                                                                                                                                                                                                                                                                                                      
                DBUNLOCK()                                                                                                                                                                                                                                                                                                                                                                      
        NEXT                                                                                                                                                                                                                                                                                                                                                                                    
ENDIF                                                                                                                                                                                                                                                                                                                                                                                           
demo_orc()
CLEAR GETS                                                                                                                                                                                                                                                                                                                                                                                      
RESTSCREEN(00,00,24,79,tela)                                                                                                                                                                                                                                                                                                                                                                    
wvw_lclosewindow()
ENDDO
wvw_lclosewindow()
RETURN NIL
*/
